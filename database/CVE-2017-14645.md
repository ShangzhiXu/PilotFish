# CVE-2017-14645

**Issue**

[https://github.com/axiomatic-systems/Bento4/issues/179](https://github.com/axiomatic-systems/Bento4/issues/179)

**PoC**

https://github.com/asarubbo/poc/raw/refs/heads/master/00335-bento4-heapoverflow-Ap4BitStream_cpp

**Patch**

https://github.com/axiomatic-systems/Bento4/commit/0312270b49a9e4b86b88ce9f666bd226b173b381
（maybe）

**Root cause**

1. `result = parser.Feed(input_buffer, &to_feed);` read input to the parser and  called `AP4_AdtsParser::FindFrame`s
2. An edge case where `AP4_AdtsParser::FindHeader` returned success and `AP4_AdtsParser::FindFrame`  keep on running after line 125
3. `AP4_AdtsParser::FindFrame`  then called `AP4_AdtsHeader::AP4_AdtsHeader`  at line 219, and init adst_header, which  read data from oarser.
4. In `AP4_AdtsParser::FindFrame`  at line 272,  `frame.m_Info.m_FrameLength = adts_header.m_FrameLength-AP4_ADTS_HEADER_SIZE;` turned out to be `-7` lead to integer underflow
5. -7 is propagated to **ReadBytes**  at line 142 in Aac2Mp4.cpp and lead to buffer overflow

 

**crash stack**

```
==60158==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x625000002100 at pc 0x7f9db884814b bp 0x7fff3d34fdb0 sp 0x7fff3d34f560
READ of size 4294963374 at 0x625000002100 thread T0
    #0 0x7f9db884814a in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827
    #1 0x563bd770839d in AP4_BitStream::ReadBytes(unsigned char*, unsigned int) /home/shangzhixu/shangzhi/CSABlindSpot/Bento4/Bento4-1.5.0-617/Source/C++/Codecs/Ap4BitStream.cpp:202
    #2 0x563bd7704ead in main /home/shangzhixu/shangzhi/CSABlindSpot/Bento4/Bento4-1.5.0-617/Source/C++/Apps/Aac2Mp4/Aac2Mp4.cpp:142
    #3 0x7f9db8646249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #4 0x7f9db8646304 in __libc_start_main_impl ../csu/libc-start.c:360
    #5 0x563bd7704430 in _start (/home/shangzhixu/shangzhi/CSABlindSpot/Bento4/Bento4-1.5.0-617/aac2mp4+0x2ff430)
```



**EDG**

```
Node _start
__libc_start_main_impl 1

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
AP4_BitStream::ReadBytes 1
AP4_FileByteStream::Create 2
AP4_SyntheticSampleTable::AP4_SyntheticSampleTable 1
AP4_AdtsParser::AP4_AdtsParser 1
AP4_AdtsParser::FindFrame 73
AP4_AdtsParser::GetBytesFree 72
AP4_StdcFileByteStream::ReadPartial 72
AP4_AdtsParser::Feed 72
AP4_Debug 1
AP4_DataBuffer::AP4_DataBuffer 1
MakeDsi 1
AP4_DataBuffer::SetData 1
AP4_MpegAudioSampleDescription::AP4_MpegAudioSampleDescription 1
AP4_SyntheticSampleTable::GetSampleDescriptionCount 1
AP4_SyntheticSampleTable::AddSampleDescription 1
AP4_DataBuffer::~AP4_DataBuffer 1
AP4_MemoryByteStream::AP4_MemoryByteStream 1

Node AP4_BitStream::ReadBytes
memcpy 1
AP4_BitStream::ByteAlign 1

Node AP4_DefaultAtomFactory::Initialize
AP4_AtomFactory::AddTypeHandler 2

Node AP4_DefaultAtomFactory::AP4_DefaultAtomFactory
AP4_DefaultAtomFactory::Initialize 2

Node AP4_StdcFileByteStream::Create
fopen_s 2
AP4_StdcFileByteStream::AP4_StdcFileByteStream 2

Node AP4_FileByteStream::Create
AP4_StdcFileByteStream::Create 2

Node AP4_BitStream::AP4_BitStream
AP4_BitStream::Reset 1

Node AP4_AdtsParser::AP4_AdtsParser
AP4_BitStream::AP4_BitStream 1

Node AP4_AdtsParser::FindFrame
AP4_BitStream::ByteAlign 73
AP4_AdtsParser::FindHeader 73
AP4_AdtsHeader::AP4_AdtsHeader 2
AP4_AdtsHeader::Check 2
AP4_BitStream::GetBytesAvailable 1
AP4_BitStream::SkipBytes 3
AP4_BitStream::PeekBytes 1
AP4_AdtsHeader::MatchFixed 1

Node AP4_AdtsParser::FindHeader
AP4_BitStream::GetBytesAvailable 73
AP4_BitStream::PeekBytes 290990

Node AP4_AdtsParser::GetBytesFree
AP4_BitStream::GetBytesFree 72

Node AP4_AdtsParser::Feed
AP4_BitStream::GetBytesFree 72
AP4_BitStream::WriteBytes 72

Node AP4_BitStream::WriteBytes
AP4_BitStream::GetBytesFree 72

Node AP4_Debug
AP4_Print 1

Node AP4_DataBuffer::SetData
AP4_DataBuffer::ReallocateBuffer 2

Node AP4_MpegSampleDescription::AP4_MpegSampleDescription
AP4_SampleDescription::AP4_SampleDescription 1
AP4_DataBuffer::AP4_DataBuffer 1
AP4_DataBuffer::SetData 1

Node AP4_MpegAudioSampleDescription::AP4_MpegAudioSampleDescription
AP4_MpegSampleDescription::AP4_MpegSampleDescription 1

Node AP4_MemoryByteStream::AP4_MemoryByteStream
AP4_DataBuffer::AP4_DataBuffer 1
AP4_DataBuffer::SetDataSize 1
```

