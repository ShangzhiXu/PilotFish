# CVE-2020-28840

**issue**

https://github.com/Fstark-prog/jhead/security/advisories/GHSA-xh27-xwgj-gqw2

[https://github.com/Matthias-Wandel/jhead/issues/8](https://github.com/Matthias-Wandel/jhead/issues/8)

**fix**

[https://github.com/Matthias-Wandel/jhead/commit/4827ed31c226dc5ed93603bd649e0e387a1778da](https://github.com/Matthias-Wandel/jhead/commit/4827ed31c226dc5ed93603bd649e0e387a1778da)

**vulnerable version**

[https://github.com/Matthias-Wandel/jhead/tree/9cee59bf79631e2c079c278f5d51abd98f9691c0](https://github.com/Matthias-Wandel/jhead/tree/9cee59bf79631e2c079c278f5d51abd98f9691c0)

**Crash stack**

```cpp
    #0 0x55c943932c2c in process_COM /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jpgfile.c:51
    #1 0x55c9439336e7 in ReadJpegSections /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jpgfile.c:240
    #2 0x55c943934024 in ReadJpegFile /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jpgfile.c:378
    #3 0x55c94392ef00 in ProcessFile /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jhead.c:905
    #4 0x55c943932876 in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jhead.c:1756
    #5 0x7f82ec446249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #6 0x7f82ec446304 in __libc_start_main_impl ../csu/libc-start.c:360
    #7 0x55c94392b560 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jhead+0xf560)
```

Root Cause

1. Input file is read in `int ReadJpegFile(const char * FileName, ReadMode_t ReadMode)` into `infile` 

2. variable `lh` and `ll` is read from input at line 158 & 159 in function `ReadJpegSections`, and assigned to `itemlen` at line 164 `itemlen = (lh << 8) | ll;`

3. `Data = (uchar *)malloc(itemlen); ` but here `itemlen = 4`

4. So in function `process_COM(Data, itemlen);`

   ```c
   static void process_COM (const uchar * Data, int length)
   			for (a=2;a<length;a++){
           ch = Data[a];
   
           if (ch == '\r' && Data[a+1] == '\n') continue; /
   ```

   when` a = 3`, it is less than `length=4`, but will visit `Data[4]`



**EDG**

```
Node _start
__libc_start_main_impl 1
_init 3
frame_dummy 3
_sub_I_00099_1 8

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
ProcessFile 1

Node ProcessFile
ReadJpegFile 1
ResetJpgfile 1
Clear_EXIF 1

Node ReadJpegFile
ReadJpegSections 1

Node ReadJpegSections
process_COM 1
CheckSectionsAllocated 1

Node frame_dummy
register_tm_clones 3
```

