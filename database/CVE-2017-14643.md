# CVE-2017-14643

**issue**

https://blogs.gentoo.org/ago/2017/09/14/bento4-heap-based-buffer-overflow-in-ap4_bytestouint32be-ap4utils-h/

**poc**

[https://blogs.gentoo.org/ago/2017/09/14/bento4-heap-based-buffer-overflow-in-ap4_bytestouint32be-ap4utils-h/](https://blogs.gentoo.org/ago/2017/09/14/bento4-heap-based-buffer-overflow-in-ap4_bytestouint32be-ap4utils-h/)

**fix**

[https://github.com/axiomatic-systems/Bento4/commit/5eb8cf89d724ccb0b4ce5f24171ec7c11f0a7647](https://github.com/axiomatic-systems/Bento4/commit/5eb8cf89d724ccb0b4ce5f24171ec7c11f0a7647)

**crash stack**

```
==41167==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x617000000324 at pc 0x55f3e33d7059 bp 0x7ffd101279a0 sp 0x7ffd10127998
READ of size 1 at 0x617000000324 thread T0
    #0 0x55f3e33d7058 in AP4_BytesToUInt32BE(unsigned char const*) (/tmp/Bento4-1.5.0-617/mp42aac+0x2fe058)
    #1 0x55f3e34ab3c0 in AP4_StszAtom::AP4_StszAtom(unsigned int, unsigned char, unsigned int, AP4_ByteStream&) (/tmp/Bento4-1.5.0-617/mp42aac+0x3d23c0)
    #2 0x55f3e34ab08c in AP4_StszAtom::Create(unsigned int, AP4_ByteStream&) (/tmp/Bento4-1.5.0-617/mp42aac+0x3d208c)
    #3 0x55f3e342e26c in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned int, unsigned int, unsigned long long, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x35526c)
    #4 0x55f3e342c097 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned long long&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x353097)
    #5 0x55f3e3453a24 in AP4_ContainerAtom::ReadChildren(AP4_AtomFactory&, AP4_ByteStream&, unsigned long long) (/tmp/Bento4-1.5.0-617/mp42aac+0x37aa24)
    #6 0x55f3e34533da in AP4_ContainerAtom::AP4_ContainerAtom(unsigned int, unsigned long long, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x37a3da)
    #7 0x55f3e3452f85 in AP4_ContainerAtom::Create(unsigned int, unsigned long long, bool, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x379f85)
    #8 0x55f3e342f876 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned int, unsigned int, unsigned long long, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x356876)
    #9 0x55f3e342c097 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned long long&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x353097)
    #10 0x55f3e3453a24 in AP4_ContainerAtom::ReadChildren(AP4_AtomFactory&, AP4_ByteStream&, unsigned long long) (/tmp/Bento4-1.5.0-617/mp42aac+0x37aa24)
    #11 0x55f3e34533da in AP4_ContainerAtom::AP4_ContainerAtom(unsigned int, unsigned long long, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x37a3da)
    #12 0x55f3e3452f85 in AP4_ContainerAtom::Create(unsigned int, unsigned long long, bool, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x379f85)
    #13 0x55f3e342f876 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned int, unsigned int, unsigned long long, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x356876)
    #14 0x55f3e342c097 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned long long&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x353097)
    #15 0x55f3e3453a24 in AP4_ContainerAtom::ReadChildren(AP4_AtomFactory&, AP4_ByteStream&, unsigned long long) (/tmp/Bento4-1.5.0-617/mp42aac+0x37aa24)
    #16 0x55f3e34533da in AP4_ContainerAtom::AP4_ContainerAtom(unsigned int, unsigned long long, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x37a3da)
    #17 0x55f3e3452f85 in AP4_ContainerAtom::Create(unsigned int, unsigned long long, bool, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x379f85)
    #18 0x55f3e342f876 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned int, unsigned int, unsigned long long, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x356876)
    #19 0x55f3e342c097 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned long long&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x353097)
    #20 0x55f3e3453a24 in AP4_ContainerAtom::ReadChildren(AP4_AtomFactory&, AP4_ByteStream&, unsigned long long) (/tmp/Bento4-1.5.0-617/mp42aac+0x37aa24)
    #21 0x55f3e34533da in AP4_ContainerAtom::AP4_ContainerAtom(unsigned int, unsigned long long, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x37a3da)
    #22 0x55f3e340034e in AP4_TrakAtom::AP4_TrakAtom(unsigned int, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x32734e)
    #23 0x55f3e343075c in AP4_TrakAtom::Create(unsigned int, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x35775c)
    #24 0x55f3e342dd85 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned int, unsigned int, unsigned long long, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x354d85)
    #25 0x55f3e342c097 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned long long&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x353097)
    #26 0x55f3e3453a24 in AP4_ContainerAtom::ReadChildren(AP4_AtomFactory&, AP4_ByteStream&, unsigned long long) (/tmp/Bento4-1.5.0-617/mp42aac+0x37aa24)
    #27 0x55f3e34533da in AP4_ContainerAtom::AP4_ContainerAtom(unsigned int, unsigned long long, bool, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x37a3da)
    #28 0x55f3e33db351 in AP4_MoovAtom::AP4_MoovAtom(unsigned int, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x302351)
    #29 0x55f3e34306e7 in AP4_MoovAtom::Create(unsigned int, AP4_ByteStream&, AP4_AtomFactory&) (/tmp/Bento4-1.5.0-617/mp42aac+0x3576e7)
    #30 0x55f3e342dbfe in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned int, unsigned int, unsigned long long, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x354bfe)
    #31 0x55f3e342c097 in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, unsigned long long&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x353097)
    #32 0x55f3e342b80e in AP4_AtomFactory::CreateAtomFromStream(AP4_ByteStream&, AP4_Atom*&) (/tmp/Bento4-1.5.0-617/mp42aac+0x35280e)
    #33 0x55f3e33d916b in AP4_File::ParseStream(AP4_ByteStream&, AP4_AtomFactory&, bool) (/tmp/Bento4-1.5.0-617/mp42aac+0x30016b)
    #34 0x55f3e33d8b65 in AP4_File::AP4_File(AP4_ByteStream&, bool) (/tmp/Bento4-1.5.0-617/mp42aac+0x2ffb65)
    #35 0x55f3e33d15d2 in main (/tmp/Bento4-1.5.0-617/mp42aac+0x2f85d2)
    #36 0x7ff30b446249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #37 0x7ff30b446304 in __libc_start_main_impl ../csu/libc-start.c:360
    #38 0x55f3e33d0420 in _start (/tmp/Bento4-1.5.0-617/mp42aac+0x2f7420)
```



**Root cause**

The input is initialized as a stream using `AP4_FileByteStream::Create` at line 229 in the `main` function. After that, an `AP4_File` object attempts to parse the input at line 242. The input gradually propagates to `AP4_StszAtom::Create(AP4_Size size, AP4_ByteStream& stream)` and further to the `AP4_StszAtom` constructor.

At line 78 of the `AP4_StszAtom` constructor, an integer overflow occurs when calculating `sample_count * 4`. The value of `sample_count` is `1073741993`, leading to:

```
sample_count * 4 = 676
```

This causes the buffer size to be much smaller than `sample_count`, resulting in a buffer overflow at line 85 when an unexpected index of the buffer is accessed.



**EDG**

```
Node _start
__libc_start_main_impl 1

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
AP4_File::AP4_File 1

Node AP4_File::AP4_File
AP4_File::ParseStream 1
AP4_AtomParent::AP4_AtomParent 1
AP4_DefaultAtomFactory::AP4_DefaultAtomFactory 1

Node AP4_File::ParseStream
AP4_AtomFactory::CreateAtomFromStream 2
AP4_StdcFileByteStream::Tell 2
AP4_AtomParent::AddChild 1
AP4_Atom::GetType 1

Node AP4_AtomFactory::CreateAtomFromStream
AP4_AtomFactory::CreateAtomFromStream 22
AP4_MoovAtom::Create 1
AP4_TrakAtom::Create 1
AP4_ContainerAtom::Create 4
AP4_StszAtom::Create 1
AP4_StdcFileByteStream::GetSize 2
AP4_StdcFileByteStream::Tell 22
AP4_ByteStream::ReadUI32 40
AP4_AtomFactory::GetContext 20
AP4_FtypAtom::Create 1
AP4_StdcFileByteStream::Seek 14
AP4_MvhdAtom::Create 1
AP4_IodsAtom::Create 1
AP4_TkhdAtom::Create 1
AP4_MdhdAtom::Create 1
AP4_HdlrAtom::Create 1
AP4_SmhdAtom::Create 1
AP4_UrlAtom::Create 1
AP4_DrefAtom::Create 1
AP4_SttsAtom::Create 1
AP4_EsdsAtom::Create 1
AP4_Mp4aSampleEntry::AP4_Mp4aSampleEntry 1
AP4_StsdAtom::Create 1

Node AP4_MoovAtom::Create
AP4_MoovAtom::AP4_MoovAtom 1

Node AP4_MoovAtom::AP4_MoovAtom
AP4_ContainerAtom::AP4_ContainerAtom 1

Node AP4_ContainerAtom::AP4_ContainerAtom
AP4_ContainerAtom::ReadChildren 6
AP4_Atom::AP4_Atom 9
AP4_AtomParent::AP4_AtomParent 9
AP4_Atom::GetHeaderSize 6

Node AP4_ContainerAtom::ReadChildren
AP4_AtomFactory::CreateAtomFromStream 18
AP4_AtomFactory::PushContext 7
AP4_Atom::SetParent 11
AP4_AtomFactory::PopContext 2

Node AP4_TrakAtom::Create
AP4_TrakAtom::AP4_TrakAtom 1

Node AP4_TrakAtom::AP4_TrakAtom
AP4_ContainerAtom::AP4_ContainerAtom 1

Node AP4_ContainerAtom::Create
AP4_ContainerAtom::AP4_ContainerAtom 4

Node AP4_StszAtom::Create
AP4_StszAtom::AP4_StszAtom 1
AP4_Atom::ReadFullHeader 1

Node AP4_StszAtom::AP4_StszAtom
AP4_BytesToUInt32BE 170
AP4_Atom::AP4_Atom 1
AP4_ByteStream::ReadUI32 2
AP4_ByteStream::Read 1

Node AP4_DefaultBlockCipherFactory::AP4_DefaultBlockCipherFactory
AP4_BlockCipherFactory::AP4_BlockCipherFactory 1

Node AP4_DefaultAtomFactory::AP4_DefaultAtomFactory
AP4_AtomFactory::AP4_AtomFactory 3
AP4_DefaultAtomFactory::Initialize 3

Node AP4_MetaDataAtomTypeHandler::AP4_MetaDataAtomTypeHandler
AP4_AtomFactory::TypeHandler::TypeHandler 3

Node AP4_DefaultAtomFactory::Initialize
AP4_MetaDataAtomTypeHandler::AP4_MetaDataAtomTypeHandler 3
AP4_AtomFactory::AddTypeHandler 3

Node AP4_MarlinIpmpAtomFactory::AP4_MarlinIpmpAtomFactory
AP4_DefaultAtomFactory::AP4_DefaultAtomFactory 1
AP4_MarlinIpmpAtomTypeHandler::AP4_MarlinIpmpAtomTypeHandler 1
AP4_AtomFactory::AddTypeHandler 1

Node AP4_MarlinIpmpAtomTypeHandler::AP4_MarlinIpmpAtomTypeHandler
AP4_AtomFactory::TypeHandler::TypeHandler 1

Node AP4_ByteStream::AP4_ByteStream
AP4_Referenceable::AP4_Referenceable 3

Node AP4_StdcFileByteStream::AP4_StdcFileByteStream
AP4_ByteStream::AP4_ByteStream 2

Node AP4_StdcFileByteStream::Create
AP4_StdcFileByteStream::AP4_StdcFileByteStream 2

Node AP4_FileByteStream::Create
AP4_StdcFileByteStream::Create 2

Node AP4_ByteStream::Read
AP4_StdcFileByteStream::ReadPartial 149
AP4_SubStream::ReadPartial 7

Node AP4_ByteStream::ReadUI32
AP4_ByteStream::Read 109
AP4_BytesToUInt32BE 109

Node AP4_FtypAtom::AP4_FtypAtom
AP4_Atom::AP4_Atom 1
AP4_ByteStream::ReadUI32 7

Node AP4_Atom::AP4_Atom
AP4_Atom::SetSize 9

Node AP4_FtypAtom::Create
AP4_FtypAtom::AP4_FtypAtom 1

Node AP4_AtomParent::AddChild
AP4_Atom::GetParent 1
AP4_Atom::SetParent 1
AP4_AtomParent::OnChildAdded 1

Node AP4_Atom::ReadFullHeader
AP4_ByteStream::ReadUI32 12

Node AP4_MvhdAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_MvhdAtom::AP4_MvhdAtom 1

Node AP4_MvhdAtom::AP4_MvhdAtom
AP4_Atom::AP4_Atom 1
AP4_ByteStream::ReadUI32 15
AP4_ByteStream::ReadUI16 1
AP4_ByteStream::Read 3

Node AP4_ByteStream::ReadUI16
AP4_ByteStream::Read 16
AP4_BytesToUInt16BE 16

Node AP4_IodsAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_IodsAtom::AP4_IodsAtom 1

Node AP4_IodsAtom::AP4_IodsAtom
AP4_Atom::AP4_Atom 1
AP4_DescriptorFactory::CreateDescriptorFromStream 1

Node AP4_DescriptorFactory::CreateDescriptorFromStream
AP4_StdcFileByteStream::Tell 2
AP4_ByteStream::ReadUI08 16
AP4_SubStream::Tell 2
AP4_EsIdIncDescriptor::AP4_EsIdIncDescriptor 1
AP4_SubStream::Seek 2
AP4_InitialObjectDescriptor::AP4_InitialObjectDescriptor 1
AP4_StdcFileByteStream::Seek 2
AP4_IpmpDescriptor::AP4_IpmpDescriptor 1

Node AP4_ByteStream::ReadUI08
AP4_ByteStream::Read 22

Node AP4_Descriptor::AP4_Descriptor
AP4_Expandable::AP4_Expandable 3

Node AP4_ObjectDescriptor::AP4_ObjectDescriptor
AP4_Descriptor::AP4_Descriptor 1
AP4_String::AP4_String 1

Node AP4_InitialObjectDescriptor::AP4_InitialObjectDescriptor
AP4_ObjectDescriptor::AP4_ObjectDescriptor 1
AP4_StdcFileByteStream::Tell 2
AP4_ByteStream::ReadUI16 1
AP4_ByteStream::ReadUI08 5
AP4_SubStream::AP4_SubStream 1
AP4_DescriptorFactory::CreateDescriptorFromStream 2
AP4_SubStream::Release 1

Node AP4_SubStream::AP4_SubStream
AP4_ByteStream::AP4_ByteStream 1
AP4_StdcFileByteStream::AddReference 1

Node AP4_SubStream::ReadPartial
AP4_StdcFileByteStream::Seek 6
AP4_StdcFileByteStream::ReadPartial 6

Node AP4_EsIdIncDescriptor::AP4_EsIdIncDescriptor
AP4_Descriptor::AP4_Descriptor 1
AP4_ByteStream::ReadUI32 1

Node AP4_SubStream::~AP4_SubStream
AP4_StdcFileByteStream::Release 1
AP4_ByteStream::~AP4_ByteStream 1
AP4_SubStream::~AP4_SubStream 1

Node AP4_ByteStream::~AP4_ByteStream
AP4_Referenceable::~AP4_Referenceable 1

Node AP4_SubStream::Release
AP4_SubStream::~AP4_SubStream 1

Node AP4_TkhdAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_TkhdAtom::AP4_TkhdAtom 1

Node AP4_TkhdAtom::AP4_TkhdAtom
AP4_Atom::AP4_Atom 1
AP4_ByteStream::ReadUI32 16
AP4_ByteStream::Read 1
AP4_ByteStream::ReadUI16 4

Node AP4_MdhdAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_MdhdAtom::AP4_MdhdAtom 1

Node AP4_MdhdAtom::AP4_MdhdAtom
AP4_Atom::AP4_Atom 1
AP4_String::AP4_String 1
AP4_ByteStream::ReadUI32 4
AP4_ByteStream::Read 1
AP4_String::Assign 1

Node AP4_HdlrAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_HdlrAtom::AP4_HdlrAtom 1

Node AP4_HdlrAtom::AP4_HdlrAtom
AP4_Atom::AP4_Atom 1
AP4_String::AP4_String 1
AP4_ByteStream::ReadUI32 5
AP4_ByteStream::Read 1
AP4_String::operator= 1

Node AP4_String::operator=
AP4_String::Assign 1

Node AP4_SmhdAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_SmhdAtom::AP4_SmhdAtom 1

Node AP4_SmhdAtom::AP4_SmhdAtom
AP4_Atom::AP4_Atom 1
AP4_ByteStream::ReadUI16 2

Node AP4_DrefAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_DrefAtom::AP4_DrefAtom 1

Node AP4_DrefAtom::AP4_DrefAtom
AP4_ContainerAtom::AP4_ContainerAtom 1
AP4_ByteStream::ReadUI32 1
AP4_AtomFactory::CreateAtomFromStream 2

Node AP4_UrlAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_UrlAtom::AP4_UrlAtom 1

Node AP4_UrlAtom::AP4_UrlAtom
AP4_Atom::AP4_Atom 1
AP4_String::AP4_String 1

Node AP4_SttsAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_SttsAtom::AP4_SttsAtom 1

Node AP4_SttsAtom::AP4_SttsAtom
AP4_Atom::AP4_Atom 1
AP4_ByteStream::ReadUI32 3
AP4_SttsTableEntry::AP4_SttsTableEntry 1

Node AP4_StsdAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_StsdAtom::AP4_StsdAtom 1

Node AP4_StsdAtom::AP4_StsdAtom
AP4_ContainerAtom::AP4_ContainerAtom 1
AP4_ByteStream::ReadUI32 1
AP4_AtomFactory::PushContext 1
AP4_AtomFactory::CreateAtomFromStream 1
AP4_Atom::SetParent 1
AP4_AtomFactory::PopContext 1

Node AP4_SampleEntry::AP4_SampleEntry
AP4_ContainerAtom::AP4_ContainerAtom 1

Node AP4_AudioSampleEntry::AP4_AudioSampleEntry
AP4_SampleEntry::AP4_SampleEntry 1
AP4_DataBuffer::AP4_DataBuffer 1
AP4_SampleEntry::Read 1

Node AP4_SampleEntry::ReadFields
AP4_ByteStream::Read 1
AP4_ByteStream::ReadUI16 1

Node AP4_AudioSampleEntry::ReadFields
AP4_SampleEntry::ReadFields 1
AP4_ByteStream::ReadUI16 6
AP4_ByteStream::ReadUI32 2

Node AP4_SampleEntry::Read
AP4_AudioSampleEntry::ReadFields 1
AP4_Atom::GetSize 1
AP4_Atom::GetHeaderSize 1
AP4_AudioSampleEntry::GetFieldsSize 1
AP4_ContainerAtom::ReadChildren 1

Node AP4_AudioSampleEntry::GetFieldsSize
AP4_SampleEntry::GetFieldsSize 1

Node AP4_EsdsAtom::Create
AP4_Atom::ReadFullHeader 1
AP4_EsdsAtom::AP4_EsdsAtom 1

Node AP4_EsdsAtom::AP4_EsdsAtom
AP4_Atom::AP4_Atom 1
AP4_DescriptorFactory::CreateDescriptorFromStream 1

Node AP4_IpmpDescriptor::AP4_IpmpDescriptor
AP4_Descriptor::AP4_Descriptor 1
AP4_String::AP4_String 1
AP4_DataBuffer::AP4_DataBuffer 1
AP4_ByteStream::ReadUI08 1
AP4_ByteStream::ReadUI16 1
AP4_ByteStream::Read 1
AP4_String::Assign 1

Node AP4_MpegAudioSampleEntry::AP4_MpegAudioSampleEntry
AP4_AudioSampleEntry::AP4_AudioSampleEntry 1

Node AP4_Mp4aSampleEntry::AP4_Mp4aSampleEntry
AP4_MpegAudioSampleEntry::AP4_MpegAudioSampleEntry 1
```



