# CVE-2017-9038

**Issue**

https://blogs.gentoo.org/ago/2017/05/12/binutils-multiple-crashes/

**poc**

[https://github.com/asarubbo/poc/raw/refs/heads/master/00258-binutils-readelf-heapoverflow2-byte_get_little_endian](https://github.com/asarubbo/poc/raw/refs/heads/master/00258-binutils-readelf-heapoverflow2-byte_get_little_endian)



**Patch**

[https://github.com/bminor/binutils-gdb/commit/75ec1fdbb797a389e4fe4aaf2e15358a070dcc19](https://github.com/bminor/binutils-gdb/commit/75ec1fdbb797a389e4fe4aaf2e15358a070dcc19)

https://github.com/bminor/binutils-gdb/commit/c4ab9505b53cdc899506ed421fddb7e1f8faf7a3

**Root cause**

1. the file propagate to function `process_mips_specific (FILE * file)` and then the program start to visit each item in the GOT table with `ent = print_mips_got_entry (data, pltgot, ent, data_end);`

2. ent stores the content in the GOT table, it is defined by user, thus it can lead to buffer overflow if it is not well checked.

3. Here, `ent = 6299656` and `pltgot = 6299648` 

   `addrsize = 8 `    `data_end = 0x602000000038 `     `data + ent - pltgot = 0x602000000038` . 

   So  `data + ent - pltgot > data_end - addrsize` and lead to buffer ovreflow

**Crash stack**

```cpp
=================================================================
==1476165==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000000039 at pc 0x555555666f8a bp 0x7fffffffd940 sp 0x7fffffffd938
READ of size 1 at 0x602000000039 thread T0
    #0 0x555555666f89 in byte_get_little_endian /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/elfcomm.c:210
    #1 0x55555562db32 in process_mips_specific /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:15190
    #2 0x5555556341dd in process_arch_specific /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:16565
    #3 0x555555634f98 in process_object /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:16770
    #4 0x5555556367dc in process_file /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:17138
    #5 0x555555636b86 in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:17209
    #6 0x7ffff7646249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #7 0x7ffff7646304 in __libc_start_main_impl ../csu/libc-start.c:360
    #8 0x5555555e1570 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf+0x8d570)

0x602000000039 is located 0 bytes to the right of 9-byte region [0x602000000030,0x602000000039)
allocated by thread T0 here:
    #0 0x7ffff78b89cf in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:69
    #1 0x5555555eb11a in get_data /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:392
    #2 0x55555562d92f in process_mips_specific /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:15169
    #3 0x5555556341dd in process_arch_specific /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:16565
    #4 0x555555634f98 in process_object /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:16770
    #5 0x5555556367dc in process_file /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:17138
    #6 0x555555636b86 in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/readelf.c:17209
    #7 0x7ffff7646249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58

SUMMARY: AddressSanitizer: heap-buffer-overflow /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-9038/binutils-gdb-binutils-2_28/binutils/elfcomm.c:210 in byte_get_little_endian
Shadow bytes around the buggy address:
  0x0c047fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c047fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x0c047fff8000: fa fa 00 01 fa fa 00[01]fa fa fa fa fa fa fa fa
  0x0c047fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c047fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==1476165==ABORTING
```



**EDG**

```
Node _start
__libc_start_main_impl 1
_init 3
frame_dummy 3
_sub_I_00099_1 15
_sub_I_00099_0 3

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
process_file 1
expandargv 1
parse_args 1

Node process_file
process_object 1

Node process_object
process_arch_specific 1
get_file_header 1
process_file_header 1
process_section_headers 1
process_section_groups 1
process_program_headers 1
process_dynamic_section 1
process_relocs 1
process_unwind 1
process_symbol_table 1
process_syminfo 1
process_version_sections 1
process_section_contents 1
process_notes 1
process_gnu_liblist 1

Node process_arch_specific
process_mips_specific 1

Node process_mips_specific
byte_get_little_endian 1
process_attributes 1
find_section 1
offset_from_vma 1
get_data 1
print_vma 1
print_mips_got_entry 1

Node byte_get_little_endian
read_uleb128 3785720
read_sleb128 92011

Node frame_dummy
register_tm_clones 3

Node get_file_header
byte_get_little_endian 13
get_64bit_section_headers 1

Node get_64bit_section_headers
get_data 2
cmalloc 2
byte_get_little_endian 280

Node get_data
error 54

Node cmalloc
xmalloc 11

Node process_file_header
init_dwarf_regnames 1
get_elf_class 1
get_data_encoding 1
get_osabi_name 1
get_file_type 1
get_machine_name 1
print_vma 3
get_machine_flags 1

Node process_section_headers
get_64bit_section_headers 1
get_data 1
get_64bit_elf_symbols 1
print_symbol 27
get_section_type_name 27
print_vma 81
get_elf_section_flags 27

Node get_64bit_elf_symbols
get_data 3
cmalloc 3
byte_get_little_endian 6318

Node get_program_headers
cmalloc 1
get_64bit_program_headers 1

Node get_64bit_program_headers
get_data 1
byte_get_little_endian 80

Node process_program_headers
get_program_headers 1
get_segment_type 10
print_vma 60
error 1
find_section 1
printable_section_name 28

Node get_64bit_dynamic_section
get_data 1
byte_get_little_endian 72
cmalloc 1

Node process_dynamic_section
get_64bit_dynamic_section 1
offset_from_vma 1
get_data 1
print_vma 43
get_dynamic_type 25
dynamic_section_mips_val 3

Node offset_from_vma
get_program_headers 38

Node get_dynamic_type
get_mips_dynamic_type 1

Node dynamic_section_mips_val
print_vma 3

Node process_relocs
printable_section_name 1
get_64bit_elf_symbols 1
get_data 1
dump_relocations 1

Node slurp_rela_relocs
get_data 1
cmalloc 1
byte_get_little_endian 36
byte_get_signed 18

Node byte_get_signed
byte_get_little_endian 18

Node dump_relocations
slurp_rela_relocs 1
get_reloc_type 18
get_reloc_symindex 18
elf_mips_reloc_type 18
get_symbol_version_string 6
print_vma 6
print_symbol 6

Node get_symbol_version_string
offset_from_vma 12
get_data 24
byte_get_little_endian 18

Node process_unwind
get_machine_name 1

Node process_symbol_table
offset_from_vma 2
byte_get_little_endian 3
get_dynamic_data 1

Node get_dynamic_data
cmalloc 2
byte_get_little_endian 66

Node process_version_sections
get_64bit_elf_symbols 1
get_data 66
printable_section_name 3
offset_from_vma 22
cmalloc 1
byte_get_little_endian 78
printable_section_name_from_index 1
get_ver_flags 2

Node printable_section_name_from_index
printable_section_name 1

Node get_section_contents
get_data 1

Node process_notes_at
get_section_contents 1
apply_relocations 1
printable_section_name 1
is_ia64_vms 1
byte_get_little_endian 3
process_note 1

Node process_note
get_gnu_elf_note_type 1
print_symbol 1
print_gnu_note 1

Node print_gnu_note
byte_get_little_endian 4

Node process_note_sections
process_notes_at 1

Node process_notes
process_note_sections 1

Node print_mips_got_entry
print_vma 2
byte_get_little_endian 1

Node read_uleb128
read_uleb128 1
```

