# CVE-2023-43887

**issue**

https://github.com/strukturag/libde265/issues/418

**Fix**

[https://github.com/strukturag/libde265/commit/63b596c915977f038eafd7647d1db25488a8c133](https://github.com/strukturag/libde265/commit/63b596c915977f038eafd7647d1db25488a8c133)

**PoC**

[https://drive.google.com/file/d/1ISOxgjmw9mPCs-vIh84hsgEB2MfMcwHj/view](https://drive.google.com/file/d/1ISOxgjmw9mPCs-vIh84hsgEB2MfMcwHj/view)

**Call Stack**

```cpp
==32805==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x625000002298 at pc 0x7fa52231013e bp 0x7ffce3e92740 sp 0x7ffce3e92738
READ of size 4 at 0x625000002298 thread T0
    #0 0x7fa52231013d in pic_parameter_set::dump(int) const /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/libde265/pps.cc:907
    #1 0x7fa5222999f5 in decoder_context::read_pps_NAL(bitreader&) /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/libde265/decctx.cc:587
    #2 0x7fa52229d402 in decoder_context::decode_NAL(NAL_unit*) /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/libde265/decctx.cc:1254
    #3 0x7fa52229d8ea in decoder_context::decode(int*) /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/libde265/decctx.cc:1328
    #4 0x7fa522284e61 in de265_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/libde265/de265.cc:369
    #5 0x556508b6060e in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/dec265/dec265.cc:784
    #6 0x7fa522046249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #7 0x7fa522046304 in __libc_start_main_impl ../csu/libc-start.c:360
    #8 0x556508b5e410 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-43887/libde265-6fc550faeca2bbb1c82de5f29d970f6861146862/dec265/.libs/dec265+0x5410)

```

**Root cause**

1. In `main` function, data is read from user input to variable `fh`, and then parsed & stored into `ctx` at line 729.

2. It propogate to function `de265_error decoder_context::decode(int* more)` line 1326, variable `nal` and then to `reader` in function `de265_error decoder_context::decode_NAL(NAL_unit* nal)` 

3. In function `de265_error decoder_context::read_pps_NAL(bitreader& reader)` line 584, it tried to read from reader.

4. Inside the `read` function, there is a check when setting `num_tile_columns` in case it goes over `DE265_MAX_TILE_COLUMNS`, which is 10.

   ```
     if (tiles_enabled_flag) {
       num_tile_columns = get_uvlc(br);
       if (num_tile_columns == UVLC_ERROR ||
   	num_tile_columns+1 > DE265_MAX_TILE_COLUMNS) {
         ctx->add_warning(DE265_WARNING_PPS_HEADER_INVALID, false);
         return false;
       }
       
   ```

5. After exiting due to reading more than `DE265_MAX_TILE_COLUMNS`, the headers are dumped by calling `dump`:

   ```
     bool success = new_pps->read(&reader,this);
   
     if (param_pps_headers_fd>=0) {
       new_pps->dump(param_pps_headers_fd);
     }
   
     if (success) {
       pps[ (int)new_pps->pic_parameter_set_id ] = new_pps;
     }
   ```

   

   In `dump`, the following code is executed to dump the tile column boundaries:

   ```
       LOG0("tile column boundaries: ");
       for (int i=0;i<=num_tile_columns;i++) {
         LOG1("*%d ",colBd[i]);
       }
       LOG0("*\n");
   ```

   

   As previously shown, `num_tile_columns` while be set to a higher number than `DE265_MAX_TILE_COLUMNS`. `colBd` is defined as:

   ```
   int colBd    [ DE265_MAX_TILE_COLUMNS+1 ];
   ```

   Therefore, that loop will go over `colBd` and will print all the data pointed by the values found after the limits of `colBd` in memory until the end of the loop or the next memory address is invalid.

   

**EDG**

```
Node _start
__libc_start_main_impl 1
_init 4
frame_dummy 4
_sub_I_00099_1 34
_sub_I_00099_0 3
_GLOBAL__sub_I_configparam.cc 1

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
de265_decode 3
de265_new_decoder 1
de265_set_parameter_bool 4
de265_set_parameter_int 4
de265_set_verbosity 1
de265_set_limit_TID 1
de265_push_data 1
de265_flush_data 1
de265_get_next_picture 2
de265_get_warning 2

Node de265_decode
decoder_context::decode 3

Node decoder_context::decode
decoder_context::decode_NAL 3
NAL_Parser::get_NAL_queue_length 6
NAL_Parser::is_end_of_stream 3
decoded_picture_buffer::has_free_dpb_picture 3
NAL_Parser::pop_from_NAL_queue 3

Node decoder_context::decode_NAL
decoder_context::read_pps_NAL 1
NAL_unit::size 3
NAL_unit::data 3
bitreader_init 3
nal_header::nal_header 3
nal_header::read 3
decoder_context::process_nal_hdr 3
NAL_Parser::free_NAL_unit 2
decoder_context::read_sps_NAL 1

Node decoder_context::read_pps_NAL
pic_parameter_set::dump 1
operator new 3
pic_parameter_set::pic_parameter_set 1
pic_parameter_set::read 1

Node pic_parameter_set::dump
log2fh 78

Node frame_dummy
register_tm_clones 4

Node _GLOBAL__sub_I_configparam.cc
__static_initialization_and_destruction_0 1

Node de265_init
de265_init_mutex 1
std::mutex::lock 1
init_scan_orders 1
alloc_and_init_significant_coeff_ctxIdx_lookupTable 1
std::mutex::unlock 1

Node __gthread_mutex_lock
__gthread_active_p 1

Node std::mutex::lock
__gthread_mutex_lock 1

Node init_scan_orders
init_scan_h 5
init_scan_v 5
init_scan_d 5
fill_scan_pos 4080

Node fill_scan_pos
get_scan_order 8160

Node __gthread_mutex_unlock
__gthread_active_p 1

Node std::mutex::unlock
__gthread_mutex_unlock 1

Node de265_new_decoder
de265_init 1
operator new 1
decoder_context::decoder_context 1

Node base_context::base_context
error_queue::error_queue 1
base_context::set_acceleration_functions 1

Node base_context::set_acceleration_functions
init_acceleration_functions_fallback 1
init_acceleration_functions_sse 1

Node __get_cpuid
__get_cpuid_max 1

Node init_acceleration_functions_sse
__get_cpuid 1

Node decoder_context::decoder_context
base_context::base_context 1
NAL_Parser::NAL_Parser 1
thread_pool::thread_pool 1
decoded_picture_buffer::decoded_picture_buffer 1
decoder_context::compute_framedrop_table 1

Node NAL_Parser::NAL_Parser
std::__deque_buf_size 5
operator new 2

Node thread_pool::thread_pool
std::__deque_buf_size 5
operator new 2

Node decoded_picture_buffer::decoded_picture_buffer
std::__deque_buf_size 5
operator new 2

Node decoder_context::compute_framedrop_table
decoder_context::get_highest_TID 1

Node decoder_context::calc_tid_and_framerate_ratio
decoder_context::get_highest_TID 1

Node decoder_context::set_limit_TID
decoder_context::calc_tid_and_framerate_ratio 1

Node de265_set_limit_TID
decoder_context::set_limit_TID 1

Node NAL_Parser::alloc_NAL_unit
operator new 5
NAL_unit::NAL_unit 5
NAL_unit::clear 5
NAL_unit::resize 5

Node NAL_unit::NAL_unit
nal_header::nal_header 5
operator new 10
std::__size_to_integer 5

Node NAL_unit::clear
nal_header::nal_header 5

Node NAL_Parser::push_data
NAL_Parser::alloc_NAL_unit 5
NAL_unit::size 2
NAL_unit::resize 1
NAL_unit::data 18
NAL_unit::num_skipped_bytes 8
NAL_unit::insert_skipped_byte 8
NAL_unit::set_size 5
NAL_Parser::push_to_NAL_queue 4

Node NAL_unit::insert_skipped_byte
operator new 8

Node NAL_Parser::push_to_NAL_queue
operator new 5
NAL_unit::size 5

Node de265_push_data
NAL_Parser::push_data 1

Node NAL_Parser::flush_data
NAL_Parser::push_to_NAL_queue 1

Node de265_push_end_of_NAL
NAL_Parser::flush_data 1

Node de265_flush_data
de265_push_end_of_NAL 1
NAL_Parser::flush_data 1
NAL_Parser::mark_end_of_stream 1

Node std::operator-
std::__deque_buf_size 8

Node NAL_Parser::get_NAL_queue_length
std::operator- 6

Node NAL_Parser::pop_from_NAL_queue
std::operator== 3
NAL_unit::size 3

Node bitreader_init
bitreader_refill 3

Node nal_header::read
skip_bits 3
get_bits 9

Node get_bits
bitreader_refill 6

Node decoder_context::process_nal_hdr
isIdrPic 3
isRapPic 3

Node NAL_Parser::free_NAL_unit
operator new 4
operator delete 1

Node decoded_picture_buffer::num_pictures_in_output_queue
std::operator- 2

Node decoder_context::num_pictures_in_output_queue
decoded_picture_buffer::num_pictures_in_output_queue 2

Node de265_peek_next_picture
decoder_context::num_pictures_in_output_queue 2

Node de265_get_next_picture
de265_peek_next_picture 2

Node de265_get_warning
error_queue::get_warning 2

Node decoder_context::read_sps_NAL
operator new 3
seq_parameter_set::seq_parameter_set 1
seq_parameter_set::read 1
seq_parameter_set::dump 1

Node seq_parameter_set::seq_parameter_set
video_usability_information::video_usability_information 1
sps_range_extension::sps_range_extension 1

Node seq_parameter_set::read
get_bits 14
profile_tier_level::read 1
get_uvlc 21
operator new 2
std::__size_to_integer 1
read_short_term_ref_pic_set 11
video_usability_information::read 1
seq_parameter_set::compute_derived_values 1

Node profile_data::read
get_bits 40
skip_bits 1

Node profile_tier_level::read
profile_data::read 1

Node get_uvlc
get_bits 156

Node read_short_term_ref_pic_set
get_uvlc 18
get_bits 70
ref_pic_set::compute_derived_values 11

Node video_usability_information::read
get_bits 11
get_uvlc 4

Node seq_parameter_set::compute_derived_values
ceil_div 4

Node seq_parameter_set::dump
log2fh 60
profile_tier_level::dump 1
dump_compact_short_term_ref_pic_set 11
video_usability_information::dump 1

Node profile_data::dump
log2fh 73
profile_name 1

Node profile_tier_level::dump
profile_data::dump 1

Node dump_compact_short_term_ref_pic_set
log2fh 11

Node video_usability_information::dump
log2fh 19

Node pps_range_extension::pps_range_extension
pps_range_extension::reset 1

Node pic_parameter_set::pic_parameter_set
pps_range_extension::pps_range_extension 1
pic_parameter_set::reset 1

Node pic_parameter_set::reset
pic_parameter_set::set_defaults 2

Node pic_parameter_set::read
pic_parameter_set::reset 1
get_uvlc 5
get_bits 14
decoder_context::has_sps 1
decoder_context::get_shared_sps 1
get_svlc 3
error_queue::add_warning 1

Node get_svlc
get_uvlc 3
```

