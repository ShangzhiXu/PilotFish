# CVE-2023-26733

**issue**

[https://github.com/jkriege2/TinyTIFF/issues/19](https://github.com/jkriege2/TinyTIFF/issues/19)

**fix**

[https://github.com/jkriege2/TinyTIFF/commit/304915973025d44529fc676b709de5c5744cd98d](https://github.com/jkriege2/TinyTIFF/commit/304915973025d44529fc676b709de5c5744cd98d)

**PoC**

https://github.com/10cksYiqiyinHangzhouTechnology/Security-Issue-Report-of-TinyTIFF/raw/refs/heads/main/id8

**Crash Stack**

```cpp
    #0 0x4969c6 in __asan_memcpy (/home/ubuntu/Desktop/TinyTIFF/src/asan_tinytiffreader+0x4969c6)
    #1 0x4cdff4 in TinyTIFFReader_readNextFrame /home/ubuntu/Desktop/TinyTIFF/src/tinytiffreader.c
    #2 0x4cb3e9 in TinyTIFFReader_open /home/ubuntu/Desktop/TinyTIFF/src/tinytiffreader.c:921:9
    #3 0x4d10ea in main /home/ubuntu/Desktop/TinyTIFF/src/tinytiffreader.c:1058:10
    #4 0x7ffff7c4a082 in __libc_start_main /build/glibc-SzIz7B/glibc-2.31/csu/../csu/libc-start.c:308:16
    #5 0x41c3bd in _start (/home/ubuntu/Desktop/TinyTIFF/src/asan_tinytiffreader+0x41c3bd)
```

**Root cause**

1. In `TinyTiffReader_readNextFrame`, we can see that

   ` ifd = {tag = 8451, type = 25103, count = 2601582862, value = 3680432866, value2 = 0, pvalue = 0x0, pvalue2 = 0x0}` where `pvalue` is 0x0

2. This is because `ifd` is read from `TinyTIFFReader_readIFD` at line 557 but during the execution,  `TinyTIFFReader_readIFD` , we can see that the dataflow goes to to default at the `switch(d.type)` statement at line 431, and the `d.pvalue` is never assigned.

3. `d.type` comes from user input tiff

4. Then at line611, `TinyTIFFReader_memcpy_s` is called, or we can say `memcpy(dest,  src, count);` is called

5. ` TinyTIFFReader_memcpy_s (dest=0x7ffdfdd07010, destsz=8490027128, src=0x0, count=8490027128)` here, we can see `src` is 0x0, this copy lead to buffer overflow.

**EDG**

```
Node _start
__libc_start_main 1
_init 1
frame_dummy 1

Node __libc_start_main
main 1

Node main
TinyTIFFReader_open 1

Node TinyTIFFReader_open
TinyTIFFReader_readNextFrame 1
TinyTIFFReader_getEmptyFrame 1
TinyTIFFReader_fopen 1
TIFFReader_get_byteorder 1
TinyTIFFReader_fOK 1
TinyTIFFReader_fread 1
TinyTIFFReader_readuint16 1
TinyTIFFReader_readuint32 1

Node TinyTIFFReader_readNextFrame
__asan_memcpy 1
TinyTIFFReader_freeEmptyFrame 1
TinyTIFFReader_getEmptyFrame 1
TinyTIFFReader_fseek_set 1
TinyTIFFReader_readuint16 1
TinyTIFFReader_readIFD 13154
TinyTIFFReader_freeIFD 13153

Node frame_dummy
register_tm_clones 1

Node TinyTIFFReader_readuint16
TinyTIFFReader_fread 26310

Node TinyTIFFReader_readuint32
TinyTIFFReader_fread 26309

Node TinyTIFFReader_readIFD
TinyTIFFReader_readuint16 26308
TinyTIFFReader_readuint32 26308
TinyTIFFReader_fgetpos 13154
TinyTIFFReader_fsetpos 2
TinyTIFFReader_fseek_cur 2
```





