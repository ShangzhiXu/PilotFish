# CVE-2023-38850

**Issue**

https://github.com/michaelrsweet/codedoc/issues/13

**PoC**

[https://github.com/michaelrsweet/codedoc/issues/13](https://github.com/michaelrsweet/codedoc/issues/13)

**Fix**

[https://github.com/michaelrsweet/codedoc/commit/686cd0cc2bbf60bf04ce426a04d406e8e880b391](https://github.com/michaelrsweet/codedoc/commit/686cd0cc2bbf60bf04ce426a04d406e8e880b391)

**Crash Stack**

```cpp
    #0 0x562fcdc02152 in write_html_body /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-38850/codedoc-3.6/codedoc.c:6004
    #1 0x562fcdc0168b in write_html /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-38850/codedoc-3.6/codedoc.c:5829
    #2 0x562fcdbef15f in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-38850/codedoc-3.6/codedoc.c:628
    #3 0x7f4b0fd67249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #4 0x7f4b0fd67304 in __libc_start_main_impl ../csu/libc-start.c:360
    #5 0x562fcdbed760 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-38850/codedoc-3.6/codedoc+0xf760)
```



**Tips**

You can force to load debug info  like below

```cpp

Reading symbols from ./codedoc...
(gdb) add-symbol-file /usr/lib/debug/.build-id/fd/170360a724f3a553b56d06ece7b5da9a3f0834.debug
add symbol table from file "/usr/lib/debug/.build-id/fd/170360a724f3a553b56d06ece7b5da9a3f0834.debug"
(y or n) y
Reading symbols from /usr/lib/debug/.build-id/fd/170360a724f3a553b56d06ece7b5da9a3f0834.debug...
(gdb) ptype mxml_node_t
type = struct _mxml_node_s {
    mxml_type_t type;
    struct _mxml_node_s *next;
    struct _mxml_node_s *prev;
    struct _mxml_node_s *parent;
    struct _mxml_node_s *child;
    struct _mxml_node_s *last_child;
    _mxml_value_t value;
    int ref_count;
    void *user_data;
}
(gdb)
```

**Root Cause**

1. `main` read data from argv and store in variables like `title` `author` `body` etc.

2. These data propagate to function 

   ```
   write_html_body(
       FILE        *out,         /* I - Output file */
       int         mode,         /* I - HTML or EPUB/XHTML output */
       const char  *bodyfile,     /* I - Body file */
       mmd_t       *body,        /* I - Markdown body */
       mxml_node_t *doc)         /* I - XML documentation */
   ```

3. At line 6001 and 6002, it tried to read element from the file, and try to identify the child node of node `type`

   ```
   type   = mxmlFindElement(scut, scut, "type", NULL, NULL, MXML_DESCEND_FIRST);
   string = mxmlGetText(mxmlGetLastChild(type), NULL);
   ```

4. However, in input file, there is no node after `typedef strc` which looks like this

   ```c
   typedef struc		/* ber */
   ;				/* ger */
   
     foo_s(float f, int b);
     ~foo_s();// 'get_baro_s(float f, int b);
     ~foo_s();// 'get_bar()' - Get the 
     foo = f;
     bar = b;
   }
   
   ```

   We can also see that

   ```
   type = {type = MXML_ELEMENT, next = 0x6080000004a0, prev = 0x0, parent = 0x608000000420, child = 0x0, last_child = 0x0, value = {element = {
         name = 0x6020000000b0 "type", num_attrs = 0, attrs = 0x0}, integer = 176, opaque = 0x6020000000b0 "type", real = 5.2218072424160377e-310, text = {
         whitespace = 176, string = 0x0}, custom = {data = 0x6020000000b0, destroy = 0x0}}, ref_count = 1, user_data = 0x0}
         
   type->last_child = (struct _mxml_node_s *) 0x0
   ```

   So, the child, which is 0x0, is visited with `*string` at line 6004, and lead to overflow

**EDG**

```
Node _start
__libc_start_main_impl 1
_init 4
frame_dummy 4
_sub_I_00099_1 3

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
write_html 1
new_documentation 1
filebuf_open 1
scan_file 1
is_markdown 1
mmdGetMetadata 5

Node write_html
write_html_body 1
build_toc 1
write_html_head 1
write_string 3
write_html_toc 1
free_toc 1

Node write_html_body
find_public 3
get_comment_info 1
write_description 1

Node frame_dummy
register_tm_clones 4

Node scan_file
stringbuf_clear 20
filebuf_getc 807
stringbuf_length 101
stringbuf_append 573
filebuf_ungetc 74
stringbuf_getlast 5
stringbuf_get 18
get_nth_text 13
get_nth_child 1
sort_node 3
update_comment 4
add_variable 4

Node get_nth_text
get_nth_child 13

Node add_variable
codedoc_strlcpy 8

Node build_toc
add_file_toc 1
find_public 7
add_toc 2

Node add_toc
codedoc_strlcpy 4
find_public 1

Node write_html_head
write_string 4

Node write_html_toc
write_string 2

Node get_comment_info
get_text 1

Node write_description
get_text 1
```

