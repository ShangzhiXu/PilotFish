# CVE-2023-25435

**issue**

[https://gitlab.com/libtiff/libtiff/-/issues/518](https://gitlab.com/libtiff/libtiff/-/issues/518)

**fix**

[https://gitlab.com/libtiff/libtiff/-/commit/69818e2f2d246e6631ac2a2da692c3706b849c38](https://gitlab.com/libtiff/libtiff/-/commit/69818e2f2d246e6631ac2a2da692c3706b849c38)

**PoC**

https://gitlab.com/-/project/4720790/uploads/1fa5878f749fe318df9630c0d7ffaea5/poc

**Call stack**

```
==119930==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6330000188ec at pc 0x56109c17545c bp 0x7ffda6edef40 sp 0x7ffda6edef38
READ of size 1 at 0x6330000188ec thread T0
    #0 0x56109c17545b in extractContigSamplesShifted8bits /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-25435/libtiff/tools/tiffcrop.c:3753
    #1 0x56109c18b6bd in extractSeparateRegion /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-25435/libtiff/tools/tiffcrop.c:7605
    #2 0x56109c18f62a in processCropSelections /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-25435/libtiff/tools/tiffcrop.c:8621
    #3 0x56109c171c2e in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-25435/libtiff/tools/tiffcrop.c:2807
    #4 0x7f5d599bb249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #5 0x7f5d599bb304 in __libc_start_main_impl ../csu/libc-start.c:360
    #6 0x56109c1685d0 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-25435/libtiff/tools/.libs/lt-tiffcrop+0x95d0)
```

**Root Cause**

Logic Error

1. The command is `./tools/tiffcrop -E l -Z 12:50,12:99 -e divided  -R 270  poc  /dev/null` which means rotate `270` degree at area `[12:50, 12:99]`

2. The image is loaded to `read_buff` at line 2783, inside `loadImage`, the `read_buff` is allocated according to the input tiff file.

3. But after `rotateImage` the width and length of the whole image will be exchanged, which is not expected

   ```c
   // before
   *image = {xres = 0, yres = 0, width = 32, length = 2080, res_unit = 2, bps = 1, spp = 1, planar = 1, photometric = 1, orientation = 1, compression = 4,
     adjustments = 0}
   // after
   *image = {xres = 0, yres = 0, width = 2080, length = 1, res_unit = 2, bps = 1, spp = 1, planar = 1, photometric = 1, orientation = 1, compression = 4,
     adjustments = 0}
   ```

4. The image then propagate to `extractSeparateRegion` at line 8621, and we can see the cut region is:

   ```
   regionlist = {
     {x1 = 7, x2 = 7, y1 = 0, y2 = 2079, width = 2080, length = 1, buffsize = 2081, buffptr = 0x621000000100 "b"},
     {x1 = 3, x2 = 3, y1 = 0, y2 = 2079, width = 1, length = 2080, buffsize = 2081, buffptr = 0x0},
   
   ```

   where the second region with `width` 1 but `y2` is 2079

5. Then, the loop at line 7583 goes 2079 times, and read more than expected, it should be only 1 time. So, `src = read_buffer + src_offset` `src_offset = row * 260)`  the `row` can be 2079 at most. But the buffer `read_buff = 98307` 

   

**EDG**

```
Node _start
__libc_start_main 1
_init 4
frame_dummy 4
_sub_I_00099_1 41
_sub_I_00099_0 3

Node __libc_start_main
main 1

Node main
processCropSelections 1
initImageData 1
initCropMasks 1
initPageSetup 1
initDumpOptions 1
process_command_opts 1
TIFFOpenOptionsAlloc 1
TIFFOpenOptionsSetMaxSingleMemAlloc 1
TIFFOpenExt 1
TIFFOpenOptionsFree 1
TIFFNumberOfDirectories 1
loadImage 1
getCropOffsets 1

Node processCropSelections
extractSeparateRegion 2
limitMalloc 2
_TIFFmemset 2
rotateImage 1

Node extractSeparateRegion
extractContigSamplesShifted8bits 2460

Node frame_dummy
register_tm_clones 4

Node TIFFOpenOptionsAlloc
_TIFFcalloc 1

Node TIFFOpenExt
_TIFFgetMode 1
TIFFFdOpenExt 1

Node TIFFClientOpenExt
_TIFFgetMode 1
_TIFFmallocExt 1
_TIFFmemset 1
_TIFFSetDefaultCompressionState 1
_tiffReadProc 1
_tiffMapProc 1
TIFFReadDirectory 1

Node _TIFFmallocExt
_TIFFmalloc 15

Node _tiffMapProc
_tiffSizeProc 1

Node _TIFFCheckDirNumberAndOffset
TIFFHashSetNew 2
TIFFHashSetLookup 6
TIFFHashSetInsert 4

Node TIFFHashSetFindPtr
hashFuncOffsetToNumber 6
hashFuncNumberToOffset 4
equalFuncOffsetToNumber 2

Node TIFFHashSetLookup
TIFFHashSetFindPtr 6

Node TIFFHashSetInsert
TIFFHashSetFindPtr 4
hashFuncOffsetToNumber 2
TIFFHashSetGetNewListElt 4
hashFuncNumberToOffset 2

Node TIFFReadDirectory
_TIFFCheckDirNumberAndOffset 1
TIFFFetchDirectory 1
_TIFFvoid 1
TIFFReadDirectoryCheckOrder 1
TIFFFreeDirectory 1
TIFFDefaultDirectory 1
TIFFSetField 2
TIFFReadDirectoryFindEntry 2
TIFFFetchNormalTag 10
TIFFReadDirEntryShort 1
TIFFReadDirectoryFindFieldInfo 18
TIFFWarningExtR 7
_TIFFCreateAnonField 5
_TIFFMergeFields 5
_TIFFCheckFieldIsValidForCodec 7
TIFFFieldWithTag 2
_TIFFmemcpy 2
TIFFNumberOfTiles 1
TIFFFetchStripThing 2
_TIFFGetMaxColorChannels 1
_TIFFfreeExt 1
Fax3FixupTags 1
TIFFScanlineSize 1
TIFFTileSize 1

Node TIFFFetchDirectory
_TIFFmemcpy 3
_TIFFCheckMalloc 2
_TIFFfreeExt 1

Node _TIFFCheckRealloc
_TIFFMultiplySSize 15
_TIFFreallocExt 15

Node _TIFFreallocExt
_TIFFrealloc 17

Node _TIFFCheckMalloc
_TIFFCheckRealloc 8

Node _TIFFfreeExt
_TIFFfree 5

Node TIFFWarningExtR
unixWarningHandler 240

Node TIFFReadDirectoryCheckOrder
TIFFWarningExtR 1

Node TIFFFreeDirectory
_TIFFmemset 3

Node TIFFDefaultDirectory
_TIFFGetFields 1
_TIFFSetupFields 1
_TIFFmemset 1
TIFFSetField 1

Node _TIFFMergeFields
_TIFFCheckMalloc 1
TIFFFindField 164
tagCompare 5851
_TIFFCheckRealloc 7

Node TIFFFindField
tagCompare 1098

Node _TIFFSetupFields
_TIFFMergeFields 1

Node OkToChangeTag
TIFFFindField 13

Node TIFFVSetField
OkToChangeTag 13
_TIFFVSetField 4
Fax3VSetField 9

Node _TIFFVSetField
TIFFFindField 11
TIFFSetCompressionScheme 2
TIFFFieldWithTag 10
_TIFFvoid 1
TIFFWarningExtR 1
_TIFFreallocExt 2
TIFFFieldSetGetSize 2
_TIFFCheckMalloc 1
_TIFFmemcpy 1
TIFFErrorExtR 1

Node TIFFSetCompressionScheme
TIFFFindCODEC 2
_TIFFSetDefaultCompressionState 2
TIFFInitDumpMode 1
TIFFInitCCITTFax4 1

Node TIFFFieldWithTag
TIFFFindField 12

Node TIFFSetField
TIFFVSetField 13

Node TIFFFetchNormalTag
TIFFReadDirectoryFindFieldInfo 10
TIFFReadDirEntryShort 3
TIFFSetField 8
TIFFReadDirEntryLong 4
TIFFReadDirEntryShortArray 1
_TIFFfreeExt 1
TIFFReadDirEntryOutputErr 2
TIFFReadDirEntryByteArray 2

Node TIFFReadDirEntryShort
TIFFReadDirEntryCheckedShort 3

Node InitCCITTFax3
_TIFFMergeFields 1
_TIFFmallocExt 1
_TIFFmemset 1
TIFFSetField 1

Node Fax3VSetField
_TIFFVSetField 7

Node TIFFInitCCITTFax4
InitCCITTFax3 1
_TIFFMergeFields 1
TIFFSetField 1

Node TIFFReadDirEntryLong
TIFFReadDirEntryCheckedShort 4

Node _TIFFCreateAnonField
_TIFFmallocExt 10
_TIFFmemset 5

Node TIFFIsCODECConfigured
TIFFFindCODEC 2

Node _TIFFCheckFieldIsValidForCodec
TIFFIsCODECConfigured 2

Node TIFFReadDirEntryArrayWithLimit
TIFFDataWidth 5
_TIFFCheckMalloc 3
_TIFFmemcpy 1
TIFFReadDirEntryData 2

Node TIFFReadDirEntryArray
TIFFReadDirEntryArrayWithLimit 3

Node TIFFReadDirEntryShortArray
TIFFReadDirEntryArray 1

Node TIFFReadDirEntryOutputErr
TIFFWarningExtR 2

Node TIFFReadDirEntryByteArray
TIFFReadDirEntryArray 2

Node TIFFErrorExtR
unixErrorHandler 160

Node TIFFNumberOfTiles
_TIFFMultiply32 4

Node TIFFReadDirEntryData
_TIFFmemcpy 2

Node TIFFReadDirEntryLong8ArrayWithLimit
TIFFReadDirEntryArrayWithLimit 2
_TIFFmallocExt 2
_TIFFfreeExt 2

Node TIFFFetchStripThing
TIFFReadDirEntryLong8ArrayWithLimit 2

Node TIFFScanlineSize64
_TIFFMultiply64 4

Node TIFFScanlineSize
TIFFScanlineSize64 2
_TIFFCastUInt64ToSSize 2

Node TIFFTileRowSize64
_TIFFMultiply64 12

Node TIFFVTileSize64
TIFFTileRowSize64 3
_TIFFMultiply64 3

Node TIFFTileSize64
TIFFVTileSize64 3

Node TIFFTileSize
TIFFTileSize64 3
_TIFFCastUInt64ToSSize 3

Node TIFFFdOpenExt
TIFFClientOpenExt 1

Node TIFFOpenOptionsFree
_TIFFfree 1

Node TIFFAdvanceDirectory
_TIFFCheckDirNumberAndOffset 3
_TIFFmemcpy 2
TIFFErrorExtR 1

Node TIFFNumberOfDirectories
TIFFAdvanceDirectory 2

Node TIFFVGetField
TIFFFindField 13
Fax3VGetField 8

Node TIFFVGetFieldDefaulted
TIFFVGetField 8

Node TIFFGetFieldDefaulted
TIFFVGetFieldDefaulted 8

Node loadImage
TIFFGetFieldDefaulted 8
TIFFGetField 5
TIFFScanlineSize 1
TIFFIsTiled 1
TIFFTileSize 1
TIFFNumberOfTiles 1
TIFFTileRowSize 1
limitMalloc 1
readContigTilesIntoBuffer 1

Node _TIFFVGetField
TIFFFindField 8

Node Fax3VGetField
_TIFFVGetField 8

Node TIFFGetField
TIFFVGetField 5

Node TIFFTileRowSize
TIFFTileRowSize64 3
_TIFFCastUInt64ToSSize 3

Node limitMalloc
_TIFFmalloc 5

Node readContigTilesIntoBuffer
TIFFTileRowSize 1
TIFFTileSize 1
limitMalloc 1
TIFFReadTile 96
extractContigSamplesShifted8bits 66560
_TIFFfree 1

Node TIFFReadTile
TIFFCheckRead 96
TIFFCheckTile 96
TIFFComputeTile 96
TIFFReadEncodedTile 96

Node TIFFReadEncodedTile
TIFFCheckRead 96
TIFFFillTile 96
Fax4Decode 96
_TIFFNoPostDecode 96

Node TIFFGetStrileByteCountWithErr
_TIFFGetStrileOffsetOrByteCountValue 96

Node TIFFGetStrileByteCount
TIFFGetStrileByteCountWithErr 96

Node TIFFFillTile
TIFFGetStrileByteCount 96
TIFFGetStrileOffset 192
TIFFStartTile 96

Node TIFFGetStrileOffsetWithErr
_TIFFGetStrileOffsetOrByteCountValue 192

Node TIFFGetStrileOffset
TIFFGetStrileOffsetWithErr 192

Node Fax3SetupState
TIFFTileRowSize 1
_TIFFCheckMalloc 1
_TIFFmallocExt 1

Node TIFFStartTile
Fax3SetupState 1
Fax3PreDecode 96

Node Fax3PreDecode
TIFFGetBitRevTable 96

Node Fax4Decode
_TIFFFax3fillruns 5023
Fax3Unexpected 153
Fax3BadLength 226
Fax3Extension 5
Fax3PrematureEOF 3

Node Fax3Unexpected
TIFFErrorExtR 153

Node Fax3BadLength
TIFFWarningExtR 226

Node Fax3Extension
TIFFErrorExtR 5

Node Fax3PrematureEOF
TIFFWarningExtR 3

Node rotateImage
limitMalloc 1
_TIFFmemset 1
rotateContigSamples8bits 1
_TIFFfree 1
```

