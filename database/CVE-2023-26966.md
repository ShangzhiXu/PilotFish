# CVE-2023-26966

**issue**

[https://gitlab.com/libtiff/libtiff/-/issues/530](https://gitlab.com/libtiff/libtiff/-/issues/530)

**fix**

[https://gitlab.com/libtiff/libtiff/-/commit/b0e1c25dd1d065200c8d8f59ad0afe014861a1b9](https://gitlab.com/libtiff/libtiff/-/commit/b0e1c25dd1d065200c8d8f59ad0afe014861a1b9)

**poc**

[https://gitlab.com/-/project/4720790/uploads/f08f3fad60d74ef290580cdb8f3e4918/poc](https://gitlab.com/-/project/4720790/uploads/f08f3fad60d74ef290580cdb8f3e4918/poc)

**Crash stack**

```cpp
    #0 0x7fd2fbb2e10d in uv_encode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/libtiff/tif_luv.c:961
    #1 0x7fd2fbb2ec1a in LogLuv24fromXYZ /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/libtiff/tif_luv.c:1057
    #2 0x7fd2fbb2f33a in Luv24fromXYZ /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/libtiff/tif_luv.c:1120
    #3 0x7fd2fbb2b960 in LogLuvEncode24 /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/libtiff/tif_luv.c:569
    #4 0x7fd2fbb2ca1b in LogLuvEncodeStrip /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/libtiff/tif_luv.c:722
    #5 0x7fd2fbb8431c in TIFFWriteEncodedStrip /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/libtiff/tif_write.c:308
    #6 0x5614db6a1ba6 in writeBufferToContigStrips /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/tools/tiffcrop.c:1317
    #7 0x5614db6ca867 in writeCroppedImage /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/tools/tiffcrop.c:9197
    #8 0x5614db6a9fed in main /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/tools/tiffcrop.c:2834
    #9 0x7fd2fb4d5249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #10 0x7fd2fb4d5304 in __libc_start_main_impl ../csu/libc-start.c:360
    #11 0x5614db6a05d0 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-26966/libtiff-c861f25cbcb8b3fe32ab1a0c13ced2d786eeb110/tools/.libs/lt-tiffcrop+0x95d0)
```

**Root cause**

An edge case of buffer overflow

1. `_TIFFSwab32BitData()` swaps the byte order of 32-bit values (from little-endian to big-endian), but applying it directly to IEEE 754 floating-point numbers can break their structure.
2. This happens because byte-swapping disrupts the exponent and mantissa, potentially turning valid floating-point values into NaN or Infinity.
3. In the `LogLuv` codec, this issue corrupts XYZ color values, causing NaN propagation, which eventually leads to a buffer overflow in `uv_encode()`.
4. To fix this, `NaN ` values should be checked before encoding, and byte-swapping should be performed at the correct stage to prevent corruption.

**EDG**

```
Node _start
__libc_start_main_impl 1
_init 4
frame_dummy 4
_sub_I_00099_1 41

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
writeCroppedImage 1
initImageData 1
initCropMasks 1
initPageSetup 1
initDumpOptions 1
process_command_opts 1
loadImage 1
getCropOffsets 1
createCroppedImage 1
update_output_file 1

Node writeCroppedImage
writeBufferToContigStrips 1
cpTag 36

Node writeBufferToContigStrips
TIFFWriteEncodedStrip 1

Node TIFFWriteEncodedStrip
LogLuvEncodeStrip 1

Node LogLuvEncodeStrip
LogLuvEncode24 1

Node LogLuvEncode24
Luv24fromXYZ 1

Node Luv24fromXYZ
LogLuv24fromXYZ 1

Node LogLuv24fromXYZ
uv_encode 1

Node frame_dummy
register_tm_clones 4

Node loadImage
limitMalloc 1
readContigStripsIntoBuffer 1
```

