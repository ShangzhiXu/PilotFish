# CVE-2020-28840

https://github.com/Fstark-prog/jhead/security/advisories/GHSA-xh27-xwgj-gqw2

issue

[https://github.com/Matthias-Wandel/jhead/issues/8](https://github.com/Matthias-Wandel/jhead/issues/8)

fix

[https://github.com/Matthias-Wandel/jhead/commit/4827ed31c226dc5ed93603bd649e0e387a1778da](https://github.com/Matthias-Wandel/jhead/commit/4827ed31c226dc5ed93603bd649e0e387a1778da)

vulnerable version

[https://github.com/Matthias-Wandel/jhead/tree/9cee59bf79631e2c079c278f5d51abd98f9691c0](https://github.com/Matthias-Wandel/jhead/tree/9cee59bf79631e2c079c278f5d51abd98f9691c0)

```cpp
    #0 0x55c943932c2c in process_COM /home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jpgfile.c:51
    #1 0x55c9439336e7 in ReadJpegSections /home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jpgfile.c:240
    #2 0x55c943934024 in ReadJpegFile /home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jpgfile.c:378
    #3 0x55c94392ef00 in ProcessFile /home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jhead.c:905
    #4 0x55c943932876 in main /home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jhead.c:1756
    #5 0x7f82ec446249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #6 0x7f82ec446304 in __libc_start_main_impl ../csu/libc-start.c:360
    #7 0x55c94392b560 in _start (/home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2020-28840/jhead-9cee59bf79631e2c079c278f5d51abd98f9691c0/jhead+0xf560)
```

data flow

```cpp
int ReadJpegFile(const char * FileName, ReadMode_t ReadMode)
		infile = fopen(FileName, "rb");
		ret = ReadJpegSections(infile, ReadMode);
		
		 Data = (uchar *)malloc(itemlen); 
(gdb) p itemlen
$5 = 4
     process_COM(Data, itemlen);
    
static void process_COM (const uchar * Data, int length)
			for (a=2;a<length;a++){
        ch = Data[a];

        if (ch == '\r' && Data[a+1] == '\n') continue; /
       
```

简而言之，是一个简单的逻辑错误