# CVE-2023-49992

**Issue**

https://github.com/espeak-ng/espeak-ng/issues/1827

**PoC**

[https://github.com/SEU-SSL/Poc/raw/refs/heads/main/espeak-ng/id_000209,sig_07,src_000384,op_havoc,rep_32](https://github.com/SEU-SSL/Poc/raw/refs/heads/main/espeak-ng/id_000209,sig_07,src_000384,op_havoc,rep_32)

**Patch**

https://github.com/espeak-ng/espeak-ng/pull/1846/commits/b99f332c576eb49839613a55cfd3e0e1b5487191

**Crash Stack**

```
    #0 0x7f3d6be48060 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827
    #1 0x7f3d6bccb4f3 in RemoveEnding src/libespeak-ng/dictionary.c:3075
    #2 0x7f3d6bd18e66 in TranslateWord3 src/libespeak-ng/translate.c:864
    #3 0x7f3d6bd1ae94 in TranslateWord src/libespeak-ng/translate.c:1100
    #4 0x7f3d6bd1c620 in TranslateWord2 src/libespeak-ng/translate.c:1361
    #5 0x7f3d6bd26255 in TranslateClause src/libespeak-ng/translate.c:2623
    #6 0x7f3d6bd107b2 in SpeakNextClause src/libespeak-ng/synthesize.c:1569
    #7 0x7f3d6bcf7ec5 in Synthesize src/libespeak-ng/speech.c:457
    #8 0x7f3d6bcf8acf in sync_espeak_Synth src/libespeak-ng/speech.c:570
    #9 0x7f3d6bcf9076 in espeak_ng_Synthesize src/libespeak-ng/speech.c:678
    #10 0x7f3d6bcce40c in espeak_Synth src/libespeak-ng/espeak_api.c:90
    #11 0x556ffb136550 in main src/espeak-ng.c:746
    #12 0x7f3d6b767249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #13 0x7f3d6b767304 in __libc_start_main_impl ../csu/libc-start.c:360
    #14 0x556ffb1334f0 in _start (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-49992/espeak-ng-1.51/src/.libs/lt-espeak-ng+0x44f0)
```

**Root Cause**

1. In `TranslateWord3` init a buffer `char word_copy[N_WORD_BYTES];` where the size is 160

2. Then `TranslateClause`  called `ReadClause` at line 984 and  `ReadClause`  use `GetC()` near line 517 to read a word in the input, store in `sbuf[800]`and then store in variable `word`

3. In `RemoveEnding` at line 2894

   ```
   	for (word_end = word; *word_end != ' '; word_end++) {
   		// replace discarded 'e's
   		if (*word_end == REPLACED_E)
   			*word_end = 'e';
   	}
   	i = word_end - word;
   	if (word_copy != NULL) {
   		memcpy(word_copy, word, i);
   		word_copy[i] = 0;
   	}
   ```

   The loop keep on looking for the space in the word, but if the word is very long, `i` will exceed 160 and it will lead to overflow at `memcpy`  

**EDG**

```
Node _start
__libc_start_main_impl 1
_init 4
frame_dummy 4
_sub_I_00099_1 37
_sub_I_00099_0 5

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
espeak_Synth 1
strncpy0 2
espeak_ng_InitializePath 1

Node espeak_Synth
espeak_ng_Synthesize 1

Node espeak_ng_Synthesize
sync_espeak_Synth 1

Node sync_espeak_Synth
Synthesize 1
InitText 1

Node Synthesize
SpeakNextClause 1
create_text_decoder 1
text_decoder_decode_string_multibyte 1

Node SpeakNextClause
TranslateClause 1
text_decoder_eof 1

Node TranslateClause
TranslateWord2 6
ReadClause 1
isspace2 1
utf8_in2 1372
utf8_in 1323
TranslateChar 687
IsAlpha 2058
ucd_isdigit 710
ucd_isupper 685
IsSpace 694
utf8_out 679
lookupwchar 7
IsBracket 3
towlower2 2
ucd_islower 2
UpperCaseInWord 1

Node TranslateWord2
TranslateWord 6

Node TranslateWord
TranslateWord3 6

Node TranslateWord3
RemoveEnding 1
utf8_in 687
LookupDictList 6
ucd_isdigit 6
TranslateRoman 3
Unpronouncable 3
SetSpellingStress 6
TranslateRules 6
addPluralSuffixes 4
SetWordStress 4
CheckDottedAbbrev 3
IsAlpha 2
IsSuperscript 1
ucd_isalpha 2
SpeakIndividualLetters 1

Node RemoveEnding
memcpy 1

Node frame_dummy
register_tm_clones 4

Node espeak_ng_InitializePath
check_data_path 3

Node check_data_path
GetFileLength 1

Node ReadPhFile
GetFileLength 4

Node LoadPhData
ReadPhFile 4

Node espeak_ng_Initialize
LoadPhData 1
WavegenInit 1
LoadConfig 1
SetVoiceStack 1
SynthesizeInit 1
InitNamedata 1
VoiceReset 1
SetParameter 5
fifo_init 1
espeak_ng_InitializeOutput 1
espeak_ng_GetSampleRate 1
espeak_SetSynthCallback 1
espeak_ng_SetVoiceByName 1
espeak_SetPhonemeTrace 1
GetFileLength 1

Node speechPlayer_initialize
operator new 2
FrameManager::create 2
SpeechWaveGenerator::create 2
SpeechWaveGeneratorImpl::setFrameManager 2

Node FrameManager::create
operator new 2
FrameManagerImpl::FrameManagerImpl 2

Node FrameManagerImpl::FrameManagerImpl
FrameManager::FrameManager 2
std::__deque_buf_size 10
operator new 6

Node SpeechWaveGenerator::create
operator new 2
SpeechWaveGeneratorImpl::SpeechWaveGeneratorImpl 2

Node SpeechWaveGenerator::SpeechWaveGenerator
WaveGenerator::WaveGenerator 2

Node SpeechWaveGeneratorImpl::SpeechWaveGeneratorImpl
SpeechWaveGenerator::SpeechWaveGenerator 2
VoiceGenerator::VoiceGenerator 2
NoiseGenerator::NoiseGenerator 2
CascadeFormantGenerator::CascadeFormantGenerator 2
ParallelFormantGenerator::ParallelFormantGenerator 2

Node VoiceGenerator::VoiceGenerator
FrequencyGenerator::FrequencyGenerator 4
NoiseGenerator::NoiseGenerator 2

Node CascadeFormantGenerator::CascadeFormantGenerator
Resonator::Resonator 16

Node ParallelFormantGenerator::ParallelFormantGenerator
Resonator::Resonator 12

Node KlattInitSP
speechPlayer_initialize 2

Node KlattInit
KlattInitSP 1
KlattReset 1

Node SpeechWaveGeneratorImpl::~SpeechWaveGeneratorImpl
SpeechWaveGenerator::~SpeechWaveGenerator 1
SpeechWaveGeneratorImpl::~SpeechWaveGeneratorImpl 1

Node speechPlayer_terminate
SpeechWaveGeneratorImpl::~SpeechWaveGeneratorImpl 1
FrameManagerImpl::~FrameManagerImpl 1

Node FrameManagerImpl::~FrameManagerImpl
std::__deque_buf_size 1
FrameManager::~FrameManager 1
FrameManagerImpl::~FrameManagerImpl 1

Node KlattFiniSP
speechPlayer_terminate 1

Node KlattResetSP
KlattFiniSP 1
KlattInitSP 1

Node KlattReset
KlattResetSP 1
setabc 1

Node WavegenInit
KlattInit 1

Node SetVoiceStack
strncpy0 2

Node InitBreath
setresonator 18

Node VoiceReset
InitBreath 2
SetToneAdjust 2
LoadMbrolaTable 2

Node LoadMbrolaTable
SetParameter 2

Node SetParameter
SetSpeed 1
GetAmplitude 1

Node init
pop 1

Node fifo_init
init 1
say_thread 1

Node espeak_SetSynthCallback
event_set_callback 1

Node espeak_ng_SetVoiceByName
strncpy0 1
ExtractVoiceVariantName 1
LoadVoice 2
espeak_ListVoices 1
SelectVoiceByName 1
DoVoiceChange 1
SetVoiceStack 1

Node LoadVoice
strncpy0 5
GetFileLength 2
VoiceReset 1
fgets_strip 9
LookupMnem 6
SelectPhonemeTableName 2
SelectTranslator 1
CheckTranslator 1
LookupTune 4
LoadDictionary 1

Node espeak_ListVoices
FreeVoiceList 1
GetVoices 2
VoiceNameSorter 2562

Node GetVoices
GetFileLength 356
ReadVoiceFile 322
GetVoices 34

Node ReadVoiceFile
fgets_strip 3894
ucd_isspace 21730
LookupMnem 3052
strncpy0 322

Node ucd_isspace
ucd_lookup_category 23106

Node SelectVoiceByName
strncpy0 1

Node SelectPhonemeTableName
LookupPhonemeTable 2
SelectPhonemeTable 2

Node SetUpPhonemeTable
SetUpPhonemeTable 4

Node SelectPhonemeTable
SetUpPhonemeTable 2

Node NewTranslator
SetLetterBits 8
SetLengthMods 1

Node SelectTranslator
NewTranslator 1
SetupTranslator 1
SetLetterBits 1
ProcessLanguageOptions 1

Node LoadDictionary
GetFileLength 1
Reverse4Bytes 2
InitGroups 1

Node InitGroups
is_str_totally_null 112

Node DoVoiceChange
WcmdqInc 1

Node InitText
InitText2 1
InitNamedata 1

Node text_decoder_decode_string_multibyte
text_decoder_decode_string_auto 1

Node Eof
text_decoder_eof 1363

Node ReadClause
Eof 1363
GetC 681
ucd_isalnum 1360
lookupwchar2 680
ucd_isupper 680
ucd_isalpha 679
clause_type_from_codepoint 681
utf8_out 680
ucd_isspace 681
IsBracket 680

Node string_decoder_getc_auto
string_decoder_getc_utf_8 1
string_decoder_getc_codepage 1

Node text_decoder_getc
string_decoder_getc_auto 1
string_decoder_getc_codepage 680

Node GetC
text_decoder_getc 681

Node ucd_isalnum
ucd_lookup_category 1360

Node ucd_isupper
ucd_lookup_category 2052

Node ucd_isalpha
ucd_lookup_category 3851

Node clause_type_from_codepoint
ucd_lookup_category 681
ucd_properties 681

Node ucd_properties
properties_Ll 677
properties_Cc 2
properties_Po 1
properties_Lu 1

Node IsBracket
lookupwchar 697

Node utf8_in2
utf8_in 51

Node utf8_in
utf8_in2 22166

Node SubstituteChar
ucd_isupper 687
FindReplacementChars 687
towlower2 2

Node FindReplacementChars
is_str_totally_null 13053
utf8_in 12366

Node TranslateChar
SubstituteChar 687

Node IsAlpha
ucd_isalpha 3170

Node IsSpace
ucd_isspace 694

Node towlower2
ucd_tolower 5

Node ucd_islower
ucd_lookup_category 2

Node LookupDictList
utf8_nbytes 13
LookupDict2 13
strncpy0 1

Node LookupDict2
strncpy0 13
TransposeAlphabet 13
HashDictionary 13
utf8_in 2
IsAlpha 1

Node TransposeAlphabet
utf8_in 175

Node TranslateRoman
IsDigit09 3

Node Unpronouncable
utf8_in 6
AlphabetFromChar 3
IsVowel 3

Node IsVowel
IsLetter 3

Node TranslateRules
utf8_in 1034
IsAlpha 1106
IsDigit 1103
MatchRule 1103
IsBracket 14
AppendPhonemes 1088
AlphabetFromChar 3
LookupLetter 1

Node IsDigit
ucd_isdigit 1103

Node MatchRule
utf8_in 6435
utf8_in2 4012
LetterGroupNo 1898
IsLetter 2192
IsLetterGroup 1055

Node AppendPhonemes
utf8_in 83

Node SetWordStress
GetVowelStress 4

Node CheckDottedAbbrev
utf8_in 3
IsAlpha 3

Node LookupLetter
utf8_out 2
Lookup 4
ucd_isspace 1
TranslateRules 1
LookupAccentedLetter 1
SetWordStress 1

Node Lookup
LookupDictList 7

Node TranslateLetter
utf8_in 1
towlower2 1
LookupLetter 1
AlphabetFromChar 1

Node LookupAccentedLetter
Lookup 1
LookupLetter2 1

Node LookupLetter2
utf8_out 1
Lookup 2

Node SpeakIndividualLetters
TranslateLetter 1
SetSpellingStress 1
```

