# CVE-2023-49993

**Issue**

https://github.com/espeak-ng/espeak-ng/issues/1826

**PoC**

[https://github.com/SEU-SSL/Poc/raw/refs/heads/main/espeak-ng/id_000205,sig_11,src_013749,op_havoc,rep_4](https://github.com/SEU-SSL/Poc/raw/refs/heads/main/espeak-ng/id_000205,sig_11,src_013749,op_havoc,rep_4)

**Patch**

https://github.com/espeak-ng/espeak-ng/pull/1846/commits/1a7ecfc2f202438b17e742368f910e6099ce02b7](https://github.com/espeak-ng/espeak-ng/pull/1846/commits/1a7ecfc2f202438b17e742368f910e6099ce02b7)

**Call Stack**

```
=================================================================
==1524827==ERROR: AddressSanitizer: global-buffer-overflow on address 0x7ffff77f5370 at pc 0x7ffff76e2fde bp 0x7fffffffae30 sp 0x7fffffffae28
WRITE of size 4 at 0x7ffff77f5370 thread T0
    #0 0x7ffff76e2fdd in ReadClause src/libespeak-ng/readclause.c:669
    #1 0x7ffff7720736 in TranslateClause src/libespeak-ng/translate.c:2001
    #2 0x7ffff77107b2 in SpeakNextClause src/libespeak-ng/synthesize.c:1569
    #3 0x7ffff76f822e in Synthesize src/libespeak-ng/speech.c:492
    #4 0x7ffff76f8acf in sync_espeak_Synth src/libespeak-ng/speech.c:570
    #5 0x7ffff76f9076 in espeak_ng_Synthesize src/libespeak-ng/speech.c:678
    #6 0x7ffff76ce40c in espeak_Synth src/libespeak-ng/espeak_api.c:90
    #7 0x55555555b550 in main src/espeak-ng.c:746
    #8 0x7ffff7246249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #9 0x7ffff7246304 in __libc_start_main_impl ../csu/libc-start.c:360
    #10 0x5555555584f0 in _start (/home/shangzhixu/shangzhi/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2023-49993/espeak-ng-1.51/src/.libs/lt-espeak-ng+0x44f0)
```

**Root cause**

1. At line 668 in readclause.c, the loop keep on read chars from user input, and only stop when it meet with EoF or white space
2. However, if a word exceeds 60 characters, it will cause an overflow in `option_punctlist`, as the buffer is limited to 60 characters.

**EDG**

```
Node _start
__libc_start_main_impl 1
_init 4
frame_dummy 4
_sub_I_00099_1 37
_sub_I_00099_0 5

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
espeak_Synth 1
strncpy0 2
espeak_ng_InitializePath 1

Node espeak_Synth
espeak_ng_Synthesize 1

Node espeak_ng_Synthesize
sync_espeak_Synth 1

Node sync_espeak_Synth
Synthesize 1
InitText 1

Node Synthesize
SpeakNextClause 3
create_text_decoder 1
text_decoder_decode_string_multibyte 1
WavegenFill 6
SynthCallback 6
Generate 6
WcmdqUsed 6

Node SpeakNextClause
TranslateClause 2
text_decoder_eof 3
CalcPitches 2
CalcLengths 2
Generate 2
LoadVoiceVariant 2
DoVoiceChange 2
SelectPhonemeTable 1

Node TranslateClause
ReadClause 3
isspace2 2
utf8_in2 22
utf8_in 20
TranslateChar 12
IsAlpha 27
ucd_isdigit 30
ucd_isupper 2
IsSpace 23
utf8_out 3
lookupwchar 11
EmbeddedCommand 2
TranslateWord2 3
Word_EmbeddedCmd 2
Eof 2
MakePhonemeList 2
IsBracket 1

Node ReadClause
Eof 90
GetC 78
ucd_isalnum 21
lookupwchar2 9
ucd_isupper 9
ucd_isalpha 9
clause_type_from_codepoint 9
utf8_out 9
ucd_isspace 74
IsBracket 7

Node frame_dummy
register_tm_clones 4

Node espeak_ng_InitializePath
check_data_path 3

Node check_data_path
GetFileLength 1

Node ReadPhFile
GetFileLength 4

Node LoadPhData
ReadPhFile 4

Node espeak_ng_Initialize
LoadPhData 1
WavegenInit 1
LoadConfig 1
SetVoiceStack 1
SynthesizeInit 1
InitNamedata 1
VoiceReset 1
SetParameter 5
fifo_init 1
espeak_ng_InitializeOutput 1
espeak_ng_GetSampleRate 1
espeak_SetSynthCallback 1
espeak_ng_SetVoiceByName 1
espeak_SetPhonemeTrace 1
GetFileLength 1

Node speechPlayer_initialize
operator new 18
FrameManager::create 18
SpeechWaveGenerator::create 18
SpeechWaveGeneratorImpl::setFrameManager 18

Node FrameManager::create
operator new 18
FrameManagerImpl::FrameManagerImpl 18

Node FrameManagerImpl::FrameManagerImpl
FrameManager::FrameManager 18
std::__deque_buf_size 90
operator new 54

Node SpeechWaveGenerator::create
operator new 18
SpeechWaveGeneratorImpl::SpeechWaveGeneratorImpl 18

Node SpeechWaveGenerator::SpeechWaveGenerator
WaveGenerator::WaveGenerator 18

Node SpeechWaveGeneratorImpl::SpeechWaveGeneratorImpl
SpeechWaveGenerator::SpeechWaveGenerator 18
VoiceGenerator::VoiceGenerator 18
NoiseGenerator::NoiseGenerator 18
CascadeFormantGenerator::CascadeFormantGenerator 18
ParallelFormantGenerator::ParallelFormantGenerator 18

Node VoiceGenerator::VoiceGenerator
FrequencyGenerator::FrequencyGenerator 36
NoiseGenerator::NoiseGenerator 18

Node CascadeFormantGenerator::CascadeFormantGenerator
Resonator::Resonator 144

Node ParallelFormantGenerator::ParallelFormantGenerator
Resonator::Resonator 108

Node KlattInitSP
speechPlayer_initialize 18

Node KlattInit
KlattInitSP 1
KlattReset 1

Node SpeechWaveGeneratorImpl::~SpeechWaveGeneratorImpl
SpeechWaveGenerator::~SpeechWaveGenerator 17
SpeechWaveGeneratorImpl::~SpeechWaveGeneratorImpl 17

Node speechPlayer_terminate
SpeechWaveGeneratorImpl::~SpeechWaveGeneratorImpl 17
FrameManagerImpl::~FrameManagerImpl 17

Node FrameManagerImpl::~FrameManagerImpl
std::__deque_buf_size 17
FrameManager::~FrameManager 17
FrameManagerImpl::~FrameManagerImpl 17

Node KlattFiniSP
speechPlayer_terminate 17

Node KlattResetSP
KlattFiniSP 17
KlattInitSP 17

Node KlattReset
KlattResetSP 17
setabc 1

Node WavegenInit
KlattInit 1

Node SetVoiceStack
strncpy0 2

Node InitBreath
setresonator 36

Node VoiceReset
InitBreath 4
SetToneAdjust 4
LoadMbrolaTable 4

Node LoadMbrolaTable
SetParameter 4

Node SetParameter
SetSpeed 1
GetAmplitude 1

Node init
pop 1

Node fifo_init
init 1
say_thread 1

Node espeak_SetSynthCallback
event_set_callback 1

Node espeak_ng_SetVoiceByName
strncpy0 1
ExtractVoiceVariantName 1
LoadVoice 2
espeak_ListVoices 1
SelectVoiceByName 1
DoVoiceChange 1
SetVoiceStack 1

Node LoadVoice
strncpy0 9
GetFileLength 4
VoiceReset 3
fgets_strip 9
LookupMnem 6
SelectPhonemeTableName 6
SelectTranslator 3
CheckTranslator 1
LookupTune 4
LoadDictionary 3
DeleteTranslator 2

Node espeak_ListVoices
FreeVoiceList 1
GetVoices 2
VoiceNameSorter 2562

Node GetVoices
GetFileLength 356
ReadVoiceFile 322
GetVoices 34

Node ReadVoiceFile
fgets_strip 3894
ucd_isspace 21730
LookupMnem 3052
strncpy0 322

Node ucd_isspace
ucd_lookup_category 21827

Node SelectVoiceByName
strncpy0 1

Node SelectPhonemeTableName
LookupPhonemeTable 6
SelectPhonemeTable 4

Node SetUpPhonemeTable
SetUpPhonemeTable 8

Node SelectPhonemeTable
SetUpPhonemeTable 6
TranslateClause 1

Node NewTranslator
SetLetterBits 24
SetLengthMods 3

Node SelectTranslator
NewTranslator 3
SetupTranslator 3
SetLetterBits 3
ProcessLanguageOptions 3

Node LoadDictionary
GetFileLength 3
Reverse4Bytes 6
InitGroups 3

Node InitGroups
is_str_totally_null 336

Node DoVoiceChange
WcmdqInc 3

Node InitText
InitText2 1
InitNamedata 1

Node text_decoder_decode_string_multibyte
text_decoder_decode_string_auto 1

Node Eof
text_decoder_eof 92

Node string_decoder_getc_auto
string_decoder_getc_utf_8 28
string_decoder_getc_codepage 1

Node text_decoder_getc
string_decoder_getc_auto 28
string_decoder_getc_codepage 50

Node GetC
text_decoder_getc 78

Node ucd_isalnum
ucd_lookup_category 21

Node ucd_isupper
ucd_lookup_category 23

Node ucd_isalpha
ucd_lookup_category 47

Node clause_type_from_codepoint
ucd_lookup_category 9
ucd_properties 9

Node ucd_properties
properties_Ll 1
properties_Cc 6
properties_Sc 2

Node IsBracket
lookupwchar 9

Node utf8_in2
utf8_in 8

Node utf8_in
utf8_in2 264

Node SubstituteChar
ucd_isupper 12
FindReplacementChars 12

Node FindReplacementChars
is_str_totally_null 228
utf8_in 216

Node TranslateChar
SubstituteChar 12

Node IsAlpha
ucd_isalpha 35

Node IsSpace
ucd_isspace 23

Node EmbeddedCommand
IsDigit09 2
strchr_w 2

Node TranslateWord3
utf8_in 7
LookupDictList 3
CheckDottedAbbrev 3
addPluralSuffixes 3
SetWordStress 3
ucd_isalpha 3
ucd_isdigit 2
TranslateRoman 2
SetSpellingStress 2
TranslateRules 2
IsAlpha 1
IsSuperscript 1

Node LookupDictList
utf8_nbytes 5
LookupDict2 5
strncpy0 1

Node LookupDict2
strncpy0 5
TransposeAlphabet 5
HashDictionary 5
utf8_in 1
IsAlpha 1

Node TransposeAlphabet
utf8_in 6

Node CheckDottedAbbrev
utf8_in 3
IsAlpha 3

Node SetWordStress
GetVowelStress 2

Node TranslateWord
TranslateWord3 3

Node TranslateWord2
TranslateWord 3

Node MakePhonemeList
SubstitutePhonemes 2
InterpretPhoneme 8

Node InterpretPhoneme
InterpretCondition 3
NumInstnWords 3

Node CalcPitches
count_pitch_vowels 1
calc_pitches 1

Node calc_pitches2
SetPitchGradient 1
SetHeadIntonation 1

Node SetHeadIntonation
count_increments 1
CountUnstressed 1
set_pitch 1

Node calc_pitches
calc_pitches2 1

Node CalcLengths
DoEmbedded2 2

Node EndPitch
SmoothSpect 22

Node DoPause
EndPitch 13
WcmdqInc 13
PauseLength 3
InterpretPhoneme 1

Node Generate
DoPause 11
WcmdqFree 10
DoMarker 5
EndAmplitude 10
InterpretPhoneme 2
StartSyllable 1
DoAmplitude 1
DoPitch 1
DoSpect2 2
DoSample3 1
DoEmbedded 2
EndPitch 8

Node DoMarker
WcmdqFree 5
WcmdqInc 5

Node DoAmplitude
WcmdqInc 1

Node DoPitch
EndPitch 1
WcmdqInc 1

Node CopyFrame
AllocFrame 1

Node FormantTransition2
CopyFrame 1
set_frame_rms 1

Node LookupSpect
FormantTransition2 2

Node DoSpect2
LookupSpect 2
WcmdqInc 5
SmoothSpect 1

Node DoSample3
EndPitch 1
DoSample2 1

Node DoSample2
WcmdqInc 1

Node DoEmbedded
DoPause 2
WcmdqInc 2

Node LoadVoiceVariant
strncpy0 2
ExtractVoiceVariantName 2
LoadVoice 2

Node WcmdqUsed
WcmdqFree 43

Node WavegenFill2
WcmdqUsed 37
WavegenSetVoice 3
WcmdqIncHead 31
KlattReset 16
PlaySilence 13
MarkerEvent 5
SetAmplitude 1
SetPitch 1
Wavegen 7
PlayWave 3
SetEmbedded 2

Node WavegenSetEcho
GetAmplitude 3

Node WavegenSetVoice
WavegenSetEcho 3
SetPitchFormants 3
MarkerEvent 3

Node SetPitch
SetPitch2 1

Node Wavegen
SetSynth 5
PeaksToHarmspect 21
SetBreath 48
AdvanceParameters 47

Node AdvanceParameters
PeaksToHarmspect 28

Node WavegenFill
WavegenFill2 6

Node OpenWavFile
Write4Bytes 2

Node SynthCallback
OpenWavFile 1

Node SetEmbedded
SetWithRange0 2

Node TranslateRoman
IsDigit09 2

Node TranslateRules
utf8_in 3
IsAlpha 3
IsDigit 2
MatchRule 2
AppendPhonemes 1
IsBracket 1
AlphabetFromChar 1
LookupLetter 1

Node IsDigit
ucd_isdigit 2

Node LookupLetter
utf8_out 1
Lookup 2

Node Lookup
LookupDictList 2
```

