# CVE-2017-6852

**issue**

https://github.com/jasper-software/jasper/issues/114

**PoC**

https://github.com/asarubbo/poc/raw/refs/heads/master/00126-jasper-heapoverflow-jpc_dec_decodepkt

**Patch**

https://github.com/jasper-maint/jasper/commit/a10536d5f7f3164b0a1f1ae3e533f4a12ca6f543

**Tips**

```
cmake -DCMAKE_INSTALL_PREFIX=/usr \
      -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_SKIP_INSTALL_RPATH=YES \
      -DCMAKE_INSTALL_DOCDIR=/usr/share/doc/jasper-2.0.10 \
      -DCMAKE_C_FLAGS="-fsanitize=address -g -O0 -fno-inline -fkeep-inline-functions -fno-eliminate-unused-debug-types -fno-ipa-sra -DNDEBUG" \
      -DCMAKE_CXX_FLAGS="-fsanitize=address -g -O0 -fno-inline -fkeep-inline-functions -fno-eliminate-unused-debug-types -fno-ipa-sra -DNDEBUG" \
      -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address -Wl,--no-gc-sections" \
      ..
```

**Root cause**

1. The input flow to variable `des` through `dec = jpc_dec_create(opts, in)` in`jpc_decode`  and flow to `jpc_dec_decode` at line 262 and finally flow to `jpc_dec_decodepkt` with

   ```c++
   tile = dec->curtile;
   tcomp = &tile->tcomps[compno];
   rlvl = &tcomp->rlvls[rlvlno]
   for (bandno = 0, band = rlvl->bands; bandno < rlvl->numbands;
   		  ++bandno, ++bp *bandand) {
   		prc = &band->prcs[prcno];
   		if (!prc->cblks) { // crash point
   			continue;
   		}
   ```

2. dec is user constructed, if user crafted the variable `qmfbid`, make it to be not JPC_COX_INS or JPC_COX_RFT, lead to program go to wrong state.

**Crash stack**

```cpp
=================================================================
==1322810==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x61a000000608 at pc 0x7ffff4eebc95 bp 0x7fffffffd8a0 sp 0x7fffffffd898
READ of size 8 at 0x61a000000608 thread T0
    #0 0x7ffff4eebc94 in jpc_dec_decodepkt /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_t2dec.c:245
    #1 0x7ffff4eed390 in jpc_dec_decodepkts /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_t2dec.c:454
    #2 0x7ffff4e849c6 in jpc_dec_process_sod /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:628
    #3 0x7ffff4e83797 in jpc_dec_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:425
    #4 0x7ffff4e82dc4 in jpc_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:262
    #5 0x7ffff4e707e0 in jp2_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jp2/jp2_dec.c:218
    #6 0x7ffff4e4b9d6 in jas_image_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/base/jas_image.c:444
    #7 0x7ffff3bfb007  (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/BUILD/src/appl/imginfo+0x3007)
    #8 0x7ffff4b84249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58
    #9 0x7ffff4b84304 in __libc_start_main_impl ../csu/libc-start.c:360
    #10 0x7ffff3bfa2a0  (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/BUILD/src/appl/imginfo+0x22a0)

0x61a000000608 is located 48 bytes to the right of 1368-byte region [0x61a000000080,0x61a0000005d8)
allocated by thread T0 here:
    #0 0x7ffdb34b89cf in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:69
    #1 0x7ffff4e5600c in jas_malloc /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/base/jas_malloc.c:242
    #2 0x7ffff4e5612f in jas_alloc2 /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/base/jas_malloc.c:275
    #3 0x7ffff4e87079 in jpc_dec_tileinit /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:841
    #4 0x7ffff4e845eb in jpc_dec_process_sod /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:594
    #5 0x7ffff4e83797 in jpc_dec_decode /home/shangzhixu/shangzhin/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:425
    #6 0x7ffff4e82dc4 in jpc_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_dec.c:262
    #7 0x7ffff4e707e0 in jp2_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jp2/jp2_dec.c:218
    #8 0x7ffff4e4b9d6 in jas_image_decode /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/base/jas_image.c:444
    #9 0x7ffff3bfb007  (/tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/BUILD/src/appl/imginfo+0x3007)
    #10 0x7ffff4b84249 in __libc_start_call_main ../sysdeps/nptl/libc_start_call_main.h:58

SUMMARY: AddressSanitizer: heap-buffer-overflow /tmp/RootCauseAnalyzer/gdb_test/RealWorldTest/CVE-2017-6852/jasper-version-2.0.9/src/libjasper/jpc/jpc_t2dec.c:245 in jpc_dec_decodepkt
Shadow bytes around the buggy address:
  0x0c347fff8070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c347fff8080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c347fff8090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c347fff80a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c347fff80b0: 00 00 00 00 00 00 00 00 00 00 00 fa fa fa fa fa
=>0x0c347fff80c0: fa[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c347fff80d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c347fff80e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c347fff80f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c347fff8100: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c347fff8110: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==1322810==ABORTING
```



**EDG**

```
Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
jas_image_decode 1

Node jas_image_decode
jp2_decode 1
jas_image_lookupfmtbyid 1

Node jp2_decode
jpc_decode 1
jp2_dec_create 1
jp2_box_get 6
jp2_box_destroy 6
jas_getdbglevel 4

Node jpc_decode
jpc_dec_decode 1
jpc_dec_opts_create 1
jpc_initluts 1
jpc_dec_create 1
jpc_dec_opts_destroy 1

Node jpc_dec_decode
jpc_dec_process_sod 1
jpc_cstate_create 1
jpc_getms 12
jpc_dec_mstab_lookup 12
jpc_dec_process_soc 1
jpc_ms_destroy 11
jpc_dec_process_siz 1
jpc_dec_process_unk 1
jpc_dec_process_poc 1
jpc_dec_process_qcd 1
jpc_dec_process_qcc 3
jpc_dec_process_sot 1
jpc_dec_process_cod 2

Node jpc_dec_process_sod
jpc_dec_decodepkts 1
jpc_dec_cp_isvalid 1
jpc_dec_cp_prepare 1
jpc_dec_tileinit 1
jas_getdbglevel 1

Node jpc_dec_decodepkts
jpc_dec_decodepkt 60
jpc_dec_lookahead 60
jpc_pi_next 60
jas_getdbglevel 60

Node jpc_dec_decodepkt
jpc_bitstream_sopen 60
jpc_bitstream_fillbuf 60
jpc_tagtree_getleaf 71
jpc_tagtree_decode 82
jpc_bitstream_inalign 59
jpc_bitstream_close 59
jas_getdbglevel 118
jpc_getnumnewpasses 14
jpc_getcommacode 14
JPC_SEGPASSCNT 14
jpc_seg_alloc 14
jpc_seglist_insert 14
JPC_SEGTYPE 14
jpc_floorlog2 14
jpc_bitstream_getbits 14
jas_stream_memopen 14
jpc_getdata 14

Node jas_strdup
jas_malloc 31

Node jas_image_addfmt
jas_strdup 30

Node jas_init
jas_image_addfmt 10

Node jas_getopt
jas_optlookup 1

Node jas_stream_create
jas_malloc 32

Node jas_stream_fopen
jas_stream_create 1
jas_strtoopenmode 1
jas_malloc 1
jas_stream_initbuf 1

Node jas_stream_initbuf
jas_malloc 32

Node jas_stream_fillbuf
file_read 1
mem_read 12

Node jas_stream_read
jas_stream_fillbuf 2

Node mif_validate
jas_stream_read 1
jas_stream_ungetc 4

Node jas_image_getfmt
mif_validate 1
pnm_validate 3
bmp_validate 1
ras_validate 1
jp2_validate 1

Node pnm_validate
jas_stream_read 3
jas_stream_ungetc 6

Node bmp_validate
jas_stream_read 1
jas_stream_ungetc 2

Node ras_validate
jas_stream_read 1
jas_stream_ungetc 4

Node jp2_validate
jas_stream_read 1
jas_stream_ungetc 16

Node jp2_dec_create
jas_malloc 1

Node jp2_box_get
jas_malloc 6
jp2_getuint32 12
jp2_boxinfolookup 6
jas_stream_memopen 4
jas_stream_copy 4
jas_stream_rewind 4
jp2_jp_getdata 1
jas_stream_close 4
jas_getdbglevel 6
jp2_ftyp_getdata 1

Node jp2_getuint32
jas_stream_fillbuf 2

Node jas_stream_memopen2
jas_stream_create 31
jas_stream_initbuf 31
jas_malloc 62

Node jas_stream_memopen
jas_stream_memopen2 28

Node jas_stream_copy
jas_stream_flushbuf 28

Node jas_stream_flushbuf
mem_write 17

Node jas_stream_flush
jas_stream_flushbuf 19

Node jas_stream_seek
jas_stream_flush 17
mem_seek 20

Node jas_stream_rewind
jas_stream_seek 4

Node jp2_jp_getdata
jp2_getuint32 1

Node jas_stream_close
jas_stream_flush 14
mem_close 14
jas_stream_destroy 14

Node mem_close
jas_free 28

Node jas_stream_destroy
jas_free 28

Node jp2_box_destroy
jas_free 6

Node jp2_ftyp_getdata
jp2_getuint32 3

Node jpc_dec_opts_create
jas_malloc 1
jas_tvparser_create 1
jas_tvparser_next 1
jas_tvparser_destroy 1

Node jas_tvparser_create
jas_malloc 1
jas_strdup 1

Node jas_tvparser_destroy
jas_free 2

Node jpc_initmqctxs
jpc_initctxs 1

Node jpc_initluts
jpc_initmqctxs 1
jpc_getzcctxno 1024
jpc_getspb 256
jpc_getscctxno 256
jpc_getmagctxno 4096
jpc_pow2i 1152

Node jpc_dec_create
jas_malloc 1

Node jpc_dec_opts_destroy
jas_free 1

Node jpc_cstate_create
jas_malloc 1

Node jpc_ms_create
jas_malloc 12
jpc_mstab_lookup 12

Node jpc_getms
jpc_ms_create 12
jpc_getuint16 22
jpc_mstab_lookup 12
jas_getdbglevel 12
jas_stream_memopen 10
jas_stream_copy 10
jas_stream_seek 10
jpc_siz_getparms 1
jas_stream_tell 13
jas_stream_close 10
jpc_unk_getparms 1
jpc_poc_getparms 1
jas_eprintf 3
jpc_qcd_getparms 1
jpc_qcc_getparms 3
jpc_sot_getparms 1
jpc_cod_getparms 2

Node jpc_getuint16
jas_stream_fillbuf 2

Node jpc_ms_destroy
jas_free 11
jpc_siz_destroyparms 1
jpc_unk_destroyparms 1
jpc_poc_destroyparms 1
jpc_qcd_destroyparms 1
jpc_qcc_destroyparms 3
jpc_cod_destroyparms 2

Node jpc_siz_getparms
jpc_getuint16 2
jpc_getuint32 8
jas_alloc2 1
jpc_getuint8 9

Node jas_alloc2
jas_safe_size_mul 5039
jas_malloc 5039

Node jpc_getuint8
jas_stream_fillbuf 7

Node jas_stream_tell
mem_seek 13

Node jpc_dec_cp_create
jas_malloc 2
jas_alloc2 2
jpc_pchglist_create 2

Node jpc_pchglist_create
jas_malloc 4

Node jpc_dec_process_siz
jpc_dec_cp_create 1
jas_alloc2 3
jas_safe_size_mul 4
jas_safe_size_add 3

Node jpc_siz_destroyparms
jas_free 1

Node jpc_unk_getparms
jas_alloc2 1
jas_stream_read 1

Node jpc_dec_process_unk
jas_eprintf 1
jpc_ms_dump 1

Node jpc_ms_dump
jpc_mstab_lookup 1
jpc_unk_dumpparms 1

Node jpc_unk_destroyparms
jas_free 1

Node jpc_poc_getparms
jas_alloc2 1
jpc_getuint8 5
jpc_getuint16 1

Node jpc_dec_cp_setfrompoc
jpc_pchglist_numpchgs 1
jpc_pchg_copy 1
jpc_pchglist_insert 1

Node jpc_pchg_copy
jas_malloc 3

Node jas_realloc2
jas_safe_size_mul 3
jas_realloc 3

Node jpc_pchglist_insert
jas_realloc2 3

Node jpc_dec_process_poc
jpc_dec_cp_setfrompoc 1

Node jpc_poc_destroyparms
jas_free 1

Node jpc_qcx_getcompparms
jpc_getuint8 52
jas_alloc2 4
jpc_getuint16 8

Node jpc_qcd_getparms
jpc_qcx_getcompparms 1

Node jpc_dec_cp_setfromqcd
jpc_dec_cp_setfromqcx 3

Node jpc_dec_process_qcd
jpc_dec_cp_setfromqcd 1

Node jpc_qcx_destroycompparms
jas_free 4

Node jpc_qcd_destroyparms
jpc_qcx_destroycompparms 1

Node jpc_qcc_getparms
jpc_getuint8 3
jpc_qcx_getcompparms 3

Node jpc_dec_cp_setfromqcc
jpc_dec_cp_setfromqcx 3

Node jpc_dec_process_qcc
jpc_dec_cp_setfromqcc 3

Node jpc_qcc_destroyparms
jpc_qcx_destroycompparms 3

Node jpc_sot_getparms
jpc_getuint16 1
jpc_getuint32 1
jpc_getuint8 2

Node jpc_dec_process_sot
jas_alloc2 1
jas_image_create 1
jas_free 1
jpc_dec_cp_copy 1
jpc_dec_cp_resetflags 1

Node jas_image_create0
jas_malloc 1

Node jas_image_create
jas_image_create0 1
jas_alloc2 1
jas_safe_size_mul3 3
jas_image_cmpt_create 3
jas_image_setbbox 1

Node jas_safe_size_mul3
jas_safe_size_mul 12

Node jas_image_cmpt_create
jas_safe_intfast32_add 6
jas_safe_intfast32_mul3 3
jas_malloc 3
jas_safe_size_mul3 3
jas_stream_memopen2 3
jas_stream_seek 6
jas_stream_flushbuf 3

Node jas_safe_intfast32_mul3
jas_safe_intfast32_mul 6

Node jpc_dec_cp_copy
jpc_dec_cp_create 1
jpc_pchglist_destroy 1
jpc_pchglist_copy 1

Node jpc_pchglist_destroy
jas_free 1

Node jpc_pchglist_copy
jpc_pchglist_create 1
jpc_pchg_copy 1
jpc_pchglist_insert 1

Node jpc_cod_getparms
jpc_getuint8 6
jpc_getuint16 2
jpc_cox_getcompparms 2

Node jpc_cox_getcompparms
jpc_getuint8 12

Node jpc_dec_cp_setfromcod
jpc_dec_cp_setfromcox 6

Node jpc_dec_process_cod
jpc_dec_cp_setfromcod 2

Node jpc_cod_destroyparms
jpc_cox_destroycompparms 2

Node jpc_dec_tileinit
jas_alloc2 1265
jas_seq2d_create 1259
jpc_cod_gettsfb 3
jpc_tsfb_getbands 3
JPC_NOMINALGAIN 12
jpc_calcabsstepsize 12
jas_seq2d_bindsub 1256
jpc_tagtree_create 2488
jpc_dec_pi_create 1
jpc_pchglist_numpchgs 2
jpc_pchglist_get 1
jpc_pchg_copy 1
jpc_pi_addpchg 1
jpc_pi_init 1

Node jas_matrix_create
jas_malloc 1259
jas_safe_size_mul 1259
jas_alloc2 6

Node jas_seq2d_create
jas_matrix_create 1259

Node jpc_tsfb_getbands2
jpc_tsfb_getbands2 3

Node jpc_tsfb_getbands
jpc_tsfb_getbands2 3

Node jas_matrix_bindsub
jas_alloc2 1256

Node jas_seq2d_bindsub
jas_matrix_bindsub 1256

Node jpc_tagtree_alloc
jas_malloc 2488

Node jpc_tagtree_create
jpc_tagtree_alloc 2488
jas_alloc2 2488
jpc_tagtree_reset 2488

Node jpc_pi_create0
jas_malloc 1
jpc_pchglist_create 1

Node jpc_dec_pi_create
jpc_pi_create0 1
jas_alloc2 10

Node jpc_pi_addpchg
jpc_pchglist_insert 1

Node jpc_dec_lookahead
jpc_getuint16 60
jas_stream_ungetc 120

Node jpc_pi_next
jpc_pchglist_numpchgs 1
jpc_pchglist_get 1
jpc_pi_nextrpcl 60

Node jpc_bitstream_alloc
jas_malloc 60

Node jpc_bitstream_sopen
jpc_bitstream_alloc 60

Node jpc_tagtree_decode
jpc_bitstream_fillbuf 1

Node jpc_bitstream_inalign
jpc_bitstream_getbits 57

Node jpc_bitstream_getbits
jpc_bitstream_fillbuf 14

Node jpc_bitstream_align
jpc_bitstream_inalign 59

Node jpc_bitstream_close
jpc_bitstream_align 59
jas_free 59

Node jpc_getnumnewpasses
jpc_bitstream_fillbuf 1
jpc_bitstream_getbits 13

Node jpc_getcommacode
jpc_bitstream_fillbuf 1

Node jpc_seg_alloc
jas_malloc 14

Node jpc_getdata
jas_stream_copy 14
```

