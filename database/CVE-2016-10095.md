# CVE-2016-10095

**issue**

https://blogs.gentoo.org/ago/2017/01/01/libtiff-stack-based-buffer-overflow-in-_tiffvgetfield-tif_dir-c/

**poc**

https://github.com/asarubbo/poc/raw/refs/heads/master/00104-libtiff-stackoverflow-_TIFFVGetField

**fix**

https://github.com/vadz/libtiff/commit/4d4fa0b68ae9ae038959ee4f69ebe288ec892f06

**crash stack**

```
==10362==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7f3824f00090 at pc 0x7f3829624fbb bp 0x7fffe0eb1da0 sp 0x7fffe0eb1d98 WRITE of size 4 at 0x7f3824f00090 thread T0 
	#0 0x7f3829624fba in _TIFFVGetField /tmp/portage/media-libs/tiff-4.0.7/work/tiff-4.0.7/libtiff/tif_dir.c:1077:29 
	#1 0x7f382960f202 in TIFFVGetField /tmp/portage/media-libs/tiff-4.0.7/work/tiff-4.0.7/libtiff/tif_dir.c:1198:6 
	#2 0x7f382960f202 in TIFFGetField /tmp/portage/media-libs/tiff-4.0.7/work/tiff-4.0.7/libtiff/tif_dir.c:1182 
	#3 0x50a719 in tiffcp /tmp/portage/media-libs/tiff-4.0.7/work/tiff-4.0.7/tools/tiffsplit.c:183:2 
	#4 0x50a719 in main /tmp/portage/media-libs/tiff-4.0.7/work/tiff-4.0.7/tools/tiffsplit.c:89 
	#5 0x7f382871561f in __libc_start_main /var/tmp/portage/sys-libs/glibc-2.22-r4/work/glibc-2.22/csu/libc-start.c:289 
	#6 0x419a78 in _init (/usr/bin/tiffsplit+0x419a78)
```



**Root cause**

1. On the one hand function `va_arg` doesn't have bound check, which is unsafe. If only 1 `arg` is provided and call `va_arg` twice,  like in this case, it will lead to a BoF. But there are only one call of `va_arg` in this case, the vulnerability was not caused by this directly, but related to the unprotected memory access of  `va_arg` .
2. `shortv` is a uint16_t variable but here, the program visited it with `va_arg(ap, uint32_t*)` which lead to overflow.  `va_arg` doesnâ€™t have such kind of check.

Dataflow from **main**, it reads file data with **TIFFOpen** and store in variable **in**. **in** flows to **tiffcp** and finally to  **_TIFFVGetField** and part of it is stored in **fip**

now, the tag is TIFFTAG_PREDICTOR     317    /* prediction scheme w/ LZW */

Data then flow to line 1075, as the **fip** is user controlled, it can lead to the execution of line 1077 and lead to crash.

To fix it, developer add a check of user input in **TIFFOpen**



**EDG**

```
Node _start
__libc_start_main_impl 1

Node __libc_start_main_impl
__libc_start_call_main 1

Node __libc_start_call_main
main 1

Node main
tiffcp 1
TIFFOpen 1

Node tiffcp
TIFFGetField 10

Node TIFFGetField
TIFFVGetField 10

Node TIFFVGetField
_TIFFVGetField 7
TIFFFindField 10

Node _TIFFVGetField
TIFFFindField 7

Node TIFFOpen
_TIFFgetMode 2
TIFFFdOpen 2

Node TIFFClientOpen
_TIFFgetMode 2
_TIFFmalloc 2
_TIFFmemset 2
_TIFFSetDefaultCompressionState 2
_tiffReadProc 2
_tiffMapProc 1
TIFFReadDirectory 1
_tiffSeekProc 1
_tiffWriteProc 1
TIFFDefaultDirectory 1

Node _tiffMapProc
_tiffSizeProc 1

Node _TIFFCheckRealloc
_TIFFrealloc 13

Node TIFFCheckDirOffset
_TIFFCheckRealloc 1

Node TIFFReadDirectory
TIFFCheckDirOffset 1
_TIFFvoid 1
TIFFFetchDirectory 1
TIFFReadDirectoryCheckOrder 1
TIFFFreeDirectory 1
TIFFDefaultDirectory 1
TIFFSetField 3
TIFFReadDirectoryFindEntry 2
TIFFFetchNormalTag 14
TIFFReadDirEntryShort 2
TIFFReadDirectoryFindFieldInfo 17
TIFFWarningExt 1
_TIFFCreateAnonField 1
_TIFFMergeFields 1
TIFFNumberOfStrips 1
TIFFFetchStripThing 2
_TIFFFillStriles 2
_tiffSizeProc 1
TIFFScanlineSize64 1
_TIFFfree 1
DumpFixupTags 1
ChopUpSingleUncompressedStrip 1
TIFFScanlineSize 1
TIFFStripSize 1

Node TIFFFetchDirectory
_TIFFmemcpy 3
_TIFFCheckMalloc 2
TIFFReadUInt64 36
_TIFFfree 1

Node _TIFFCheckMalloc
_TIFFCheckRealloc 11

Node TIFFFreeDirectory
_TIFFmemset 1

Node TIFFDefaultDirectory
_TIFFGetFields 2
_TIFFSetupFields 2
_TIFFmemset 2
TIFFSetField 2

Node _TIFFMergeFields
_TIFFCheckMalloc 2
TIFFFindField 307
tagCompare 2166
_TIFFCheckRealloc 1

Node TIFFFindField
tagCompare 1887

Node _TIFFSetupFields
_TIFFMergeFields 2

Node OkToChangeTag
TIFFFindField 25

Node TIFFVSetField
OkToChangeTag 25
_TIFFVSetField 25

Node _TIFFVSetField
TIFFFindField 25
TIFFSetCompressionScheme 2
TIFFFieldWithTag 25
_TIFFrealloc 2
_TIFFDataSize 2
_TIFFCheckMalloc 2
_TIFFmemcpy 2

Node TIFFSetCompressionScheme
TIFFFindCODEC 2
_TIFFSetDefaultCompressionState 2
TIFFInitDumpMode 2

Node TIFFFieldWithTag
TIFFFindField 25

Node TIFFSetField
TIFFVSetField 25

Node TIFFFetchNormalTag
TIFFReadDirectoryFindFieldInfo 14
TIFFReadDirEntryShort 6
TIFFSetField 14
TIFFReadDirEntryLong 3
TIFFReadDirEntryDouble 2
TIFFReadDirEntryShortArray 1
_TIFFfree 3
TIFFReadDirEntryFloatArray 2

Node TIFFReadDirEntryShort
TIFFReadDirEntryCheckedShort 8

Node TIFFReadDirEntryLong
TIFFReadDirEntryCheckedShort 3

Node TIFFWarningExt
unixWarningHandler 1

Node _TIFFCreateAnonField
_TIFFmalloc 2
_TIFFmemset 1

Node TIFFReadDirEntryArray
TIFFDataWidth 5
_TIFFCheckMalloc 5
_TIFFmemcpy 3
TIFFReadDirEntryData 2

Node TIFFReadDirEntryLong8Array
TIFFReadDirEntryArray 2

Node TIFFFetchStripThing
TIFFReadDirEntryLong8Array 2

Node TIFFReadDirEntryDouble
TIFFReadDirEntryCheckedRational 2

Node TIFFReadDirEntryShortArray
TIFFReadDirEntryArray 1

Node TIFFReadDirEntryData
_TIFFmemcpy 2

Node TIFFReadDirEntryFloatArray
TIFFReadDirEntryArray 2
_TIFFmalloc 2
_TIFFfree 2

Node _TIFFFillStriles
_TIFFFillStrilesInternal 2

Node TIFFScanlineSize64
_TIFFMultiply64 6

Node TIFFTileRowSize64
_TIFFMultiply64 2

Node TIFFVTileSize64
TIFFTileRowSize64 1
_TIFFMultiply64 1

Node ChopUpSingleUncompressedStrip
TIFFVTileSize64 1

Node TIFFScanlineSize
TIFFScanlineSize64 1

Node TIFFVStripSize64
TIFFScanlineSize64 1
_TIFFMultiply64 1

Node TIFFStripSize64
TIFFVStripSize64 1

Node TIFFStripSize
TIFFStripSize64 1

Node TIFFFdOpen
TIFFClientOpen 2
```



